/**
 * @license - Y[wai] Report 1.0.0
 *
 * Pure Web RIA Development Solution / <CORE> Module
 *
 * (c) 2001-2016 Corebank Co.,Ltd. http://www.corebank.co.kr
 * License: Copyright(C) COREBANK. all right reserved.
 * -----------------------------------------------------------------------------
 * 본 소프트웨어(Javascript Source)는 '(주)코아뱅크'의 자산으로
 * Y[wai] Report 솔루션에 포함되어 있습니다.
 *
 * 본 소프트웨어를 Y[wai] Report 가 납품되어진 프로젝트 혹은 시스템이
 * 아닌 다른 목적으로 이용되어짐을 금하며, 본 소프트웨어를 임의로
 * 수정하여 비정상적으로 작동되어 지는 경우 당사에서 책임지지 않습니다.
 * -----------------------------------------------------------------------------
 * @description :
 *-----------------------------------------------------------------------------
 * @Classes
 *-----------------------------------------------------------------------------
 * @FileName : waiRepCode.js
 * @Version : 1.0.0
 * @Part : 코아뱅크 기술연구소
 * @Create : 황현우 / Sep, 2016 - Nov, 2016
 * @Update :
 */
 (function(){var __log=function(){var e=void 0,t=void 0;try{e=$wai.log}catch(e){}try{t=$wai.logMessage}catch(e){}this.log=function(t){void 0===e?console.log(t):e.log(t)},this.add=function(t){void 0===e?console.log(t):e.add(t)},this.printGroup=function(t){void 0!==e&&e.printGroup(t)},this.waiLog=function(e,i,n){void 0===t?console.log(i):t.log(e,i,n)},this.waiAdd=function(e,i,n){void 0===t?console.log(i):t.add(e,i,n)}},$log=new __log,__JSONService=function(e){if(this.info={dataService:"http://192.168.1.58:8090/JSONDataService",async:!0,timeOut:3e3},void 0!==$waiReport){for(var t in this.info)void 0!==$waiReport.default.downInfo[t]&&(this.info[t]=$waiReport.default.downInfo[t]);this.serviceLog=$waiReport.default.downInfo.serviceLog}for(var t in this.info)void 0!==e[t]&&(this.info[t]=e[t]);this.call=function(e){this.ajaxCall(e)},this.ajaxCall=function(e){var t=e.Service,i=e.Method,n={Service:e.Service,Method:e.Method,Data:e.Data},r={},s=JSON.stringify(n);$log.add("JSONService.Call [Request] - AJAX"),$log.add("Service : "+t),$log.add("Method  : "+i),$log.add("Data    : "+s),$log.add("<<<"),$log.printGroup(!0);var a="POST";try{a=$waiReport.const.AjaxCallType.ReportService}catch(e){}$.ajax({type:a,url:this.info.dataService,dataType:"json",async:this.info.async,timeout:this.info.timeOut,data:s,error:function(n,s,a){if(200!=n.status)r.Service=t,r.Method=i,r.Error=n,r.Success=!1;else{r.Service=t,r.Method=i,r.Error={title:"JSON String parsing error"};try{r=JSON.parse(n.responseText)}catch(e){r.Error.message=e.message}r.Success=!1}$log.add("JSONService.Call [Response] - AJAX"),$log.add("Service : "+r.Service),$log.add("Method  : "+r.Method),r.Success?($log.add("[Received Data]"),$log.add(r.Data)):($log.add("[Error]"),$log.add(r.Error)),$log.add("<<<"),$log.printGroup(!0),e.Handler(r)},success:function(t,i,n){(r=t).Success=void 0!==r.Data,$log.add("JSONService.Call [Response] - AJAX"),$log.add("Service : "+r.Service),$log.add("Method  : "+r.Method),r.Success?($log.add("[Received Data]"),$log.add(r.Data)):($log.add("[Error]"),$log.add(r.Error)),$log.add("<<<"),$log.printGroup(!0),e.Handler(r)}})}};function _base64ToArrayBuffer(e){for(var t=window.atob(e),i=t.length,n=new Uint8Array(i),r=0;r<i;r++)n[r]=t.charCodeAt(r);return n.buffer}function _export(e,t,i){new $waiReport.classes.JSONService({}).call({Service:"com.corebank.wai.report.Export",Method:e,Data:{data:i},Handler:function(e){if(e.Success){var i=new Blob([_base64ToArrayBuffer(e.Data)]);if(navigator.appVersion.toString().indexOf(".NET")>0)window.navigator.msSaveBlob(i,t);else{var n=document.createElement("a");n.href=window.URL.createObjectURL(i),n.download=t,document.body.appendChild(n),n.click()}}else console.log("Error",e)}})}$waiReport.classes.JSONService=__JSONService;var __exportExcel=function(e,t){void 0===t&&(t="default.xlsx"),_export("ExportExcel",t,e)};$waiReport.classes.exportExcel=__exportExcel;var __exportWord=function(e,t){void 0===t&&(t="default.docx"),_export("ExportWord",t,e)};$waiReport.classes.exportWord=__exportWord;var __exportPdf=function(e,t){void 0===t&&(t="default.pdf"),_export("ExportPdf",t,e)};$waiReport.classes.exportPdf=__exportPdf;var __exportPpt=function(e,t){void 0===t&&(t="default.ppt"),_export("ExportPpt",t,e)};$waiReport.classes.exportPpt=__exportPpt;var debug=!1,waiRepPath=$waiReport.default.waiRepPath,raiseThrow=!1,rmCompTypes={"AR.Label":"label","AR.Field":"textbox","AR.CheckBox":"checkbox","AR.Image":"image","AR.Line":"line","AR.Shape":"shape","AR.RTF":"rtf","AR.Frame":"frame","AR.SubReport":"subReport","AR.DataControl":"dataControl","AR.XML":"XML"};function getReportObj(e){for(var t=e;null!==t.parent&&"yrReportClass"!==t.classType;)t=t.parent;return t}function rangeCheck(e,t,i){return e<=i&&e+t>=i}function rangeCheck2(e,t,i){return e<=i&&t>=i}function linePointCheck(e,t,i){var n=-1,r=e,s=void 0===r.lineWeight?2:parseInt(r.lineWeight);s=NaN===s?2:s,s+=12;var a={l:r.x1-s/2,t:r.y1-s/2,r:r.x1+s/2,b:r.y1+s/2},o={l:r.x2-s/2,t:r.y2-s/2,r:r.x2+s/2,b:r.y2+s/2};return rangeCheck2(a.l,a.r,t)&&rangeCheck2(a.t,a.b,i)?n=0:rangeCheck2(o.l,o.r,t)&&rangeCheck2(o.t,o.b,i)&&(n=1),n}var _yrBand=function(e,t){var i=this,n=t;this.ctrl=null,this.canvas=null,this.design=null,this.objects=[];var r={};this.designMD=!1,this.yrDesign=null,this.report=null,this.top=-1,this.summaries=[];var s=1;void 0===n.script?n.script={OnFormat:"",OnBeforePrint:"",OnAfterPrint:""}:(n.script.OnFormat=void 0===n.script.OnFormat?"":n.script.OnFormat,n.script.OnBeforePrint=void 0===n.script.OnBeforePrint?"":n.script.OnBeforePrint,n.script.OnAfterPrint=void 0===n.script.OnAfterPrint?"":n.script.OnAfterPrint),this.createBand=function(){null===this.canvas&&(this.canvas=document.createElement("canvas"),this.design=document.createElement("canvas"));var e=getReportObj(this);this.report=e,this.designMD=e.designMode,this.yrDesign=e.designer,this.canvas.width=e.info.pageSetting.paper.width,this.canvas.height=n.height,this.design.width=this.canvas.width,this.design.height=this.canvas.height,debug&&console.log("      - CreateBand ["+n.name+"]",this.canvas.width,this.canvas.height);for(var t,i,s,a,o=n.objects,h=0;h<o.length;h++)t=o[h].type,s=void 0!==(i=rmCompTypes[t])?i:t,null!==(a=$waiReport.core.createComponent(this,o[h],s))&&(o[h].type=s,this.objects.push(a),""!==(a.name+"").trim()&&(r[a.name]=a))},this.regenNamedObject=function(){r={};for(var e=0;e<this.objects.length;e++){var t=this.objects[e];""!==(t.name+"").trim()&&(r[t.name]=t)}},this.addComponent=function(e){var t=null;n.objects.push(e);var i=n.objects[n.objects.length-1],r=i.type,s=rmCompTypes[r],a=void 0!==s?s:r,o=$waiReport.core.createComponent(this,i,a);return null!==o&&(t=o,this.objects.push(o)),this.regenNamedObject(),t},this.clear=function(){this.ctrl=null,this.canvas=null,this.design=null,this.objects=[],this.yrDesign=null,this.report=null,r={}},this.draw=function(e){var t,i=null;if(void 0!==e)for((i=this.canvas.getContext("2d")).clearRect(0,0,this.canvas.width,this.canvas.height),t=0;t<this.objects.length;t++)this.objects[t].doDraw(i,e);else for(i=this.canvas.getContext("2d"),t=0;t<this.objects.length;t++)this.objects[t].doDraw(i)},this.setCompValues=function(e){this.beginUpdate();for(var t=0;t<this.objects.length;t++){var i=this.objects[t],n=i.dataField;if(void 0!==n&&n+""!="")if("textbox"==i.type)i.text=e[(n+"").trim()];else if("chart"==i.type)for(t=0;t<i.data.datasets.length;t++)if(null==e[(n+"").trim()]||null==e[(n+"").trim()][t]){i.data.datasets[t].data=[];for(var r=0;r<i.data.labels.length;r++)i.data.datasets[t].data[r]=0}else i.data.datasets[t].data=e[(n+"").trim()][t];else i.dataValue=e[(n+"").trim()]}this.endUpdate()};var a=!1;this.beginUpdate=function(){a=!0},this.endUpdate=function(){a=!1},this.reDraw=function(t){if(!a){var i=this.canvas.getContext("2d"),n=this.design.getContext("2d");i.clearRect(0,0,this.canvas.width,this.canvas.height),n.clearRect(0,0,this.design.width,this.design.height);for(var r=0;r<this.objects.length;r++)if(this.objects[r].doDraw(i),1==this.designMD&&this.yrDesign.selection.hasObject(this.objects[r])){var s=this.objects[r];if("line"!==s.type)$waiReport.rtl.drawing.canvas=this.canvas,$waiReport.rtl.drawing.drawSelect([s.left,s.top,s.width,s.height]);else{i.save();var o=void 0===s.lineWeight?2:parseInt(s.lineWeight);o=NaN===o?2:o,o+=12,i.fillStyle="rgba(0,0,255,0.5)",i.fillRect(s.x1-o/2,s.y1-o/2,o,o),i.fillRect(s.x2-o/2,s.y2-o/2,o,o),i.restore()}}!0===t&&null!==e&&e.updateChild(this)}},this.updateCanvas=function(t){null!==e&&e.updateCanvas(t)},this.updateDesign=function(e){var t=this.design.getContext("2d"),i=this.report;if("insert"==e.cmd)t.clearRect(0,0,this.design.width,this.design.height),t.save(),t.fillStyle="rgba(60,60,60,0.5)",t.fillRect(0,0,this.canvas.width,this.canvas.height),i.gridMode&&($waiReport.rtl.drawing.canvas=this.design,$waiReport.rtl.drawing.drawGridModeRect([0,0,this.canvas.width,this.canvas.height],i.gridTick)),void 0!==e.drawFunc&&e.drawFunc(),t.restore();else if(t.clearRect(0,0,this.design.width,this.design.height),"clear"!==e.cmd)for(var n=!1,r=this.yrDesign.selection.pos,s=0;s<r.length;s++){var a=this.yrDesign.selection.items[s];if(a.parent!==this)break;n||(t.save(),t.fillStyle="rgba(60,60,60,0.5)",t.fillRect(0,0,this.canvas.width,this.canvas.height),i.gridMode&&($waiReport.rtl.drawing.canvas=this.design,$waiReport.rtl.drawing.drawGridModeRect([0,0,this.canvas.width,this.canvas.height],i.gridTick)),t.restore(),n=!0);var o=r[s];if("line"!==a.type)$waiReport.rtl.drawing.canvas=this.design,$waiReport.rtl.drawing.drawMRRect([o.x,o.y,o.w,o.h]);else{t.save(),t.setLineDash([]);var h=void 0===a.lineWeight?2:Number(a.lineWeight);h=h+""=="NaN"?2:h,t.lineWidth=h,t.strokeStyle="#FF4400",t.beginPath(),t.moveTo(o.x,o.y),t.lineTo(o.w,o.h),t.stroke(),t.restore()}}},this.Controls=function(e){var t=r[e];if(void 0===t){var i=new Error;if(debug&&console.warn('Sections["'+n.name+'"].Controls["'+e+'"] not founded',i),raiseThrow)throw i}return t},this.getObjectByXY=function(e,t){for(var i=null,n=null,r=this.objects.length-1;r>=0;r--)if("line"==(n=this.objects[r]).type){var s={x:n.x1,y:n.y1},a={x:n.x2,y:n.y2},o={x:e,y:t},h=void 0===n.lineWeight?2:parseInt(n.lineWeight);if(h=NaN===h?2:h,h+=10,$waiReport.rtl.util.checkLinePoint(s,a,o,h)){i=n;break}}else rangeCheck(n.left,n.width,e)&&rangeCheck(n.top,n.height,t)&&("shape"==n.type?null==i&&(i=n):(null==i||"shape"==i.type)&&(i=n));return i},this.doProcMouseEvent=function(e,t,i,n){return!0},this.getMinHeight=function(){for(var e,t,i=0,n=0;n<this.objects.length;n++)t="line"!==(e=this.objects[n]).type?e.top+e.height:e.y2,i=Math.max(i,t);return i},Object.defineProperty(this,"classType",{get:function(){return"yrBandClass"}}),Object.defineProperty(this,"parent",{get:function(){return e}}),Object.defineProperty(this,"name",{get:function(){return n.name},set:function(e){n.name=e}}),Object.defineProperty(this,"height",{get:function(){return n.height},set:function(e){n.height=e*s,i.canvas.height=n.height,i.design.height=i.canvas.height}}),Object.defineProperty(this,"type",{get:function(){return n.type},set:function(e){n.type=e}}),Object.defineProperty(this,"info",{get:function(){return n}}),Object.defineProperty(this,"children",{get:function(){return i.objects}}),Object.defineProperty(this,"dataField",{get:function(){return n.dataField},set:function(e){n.dataField=e}}),Object.defineProperty(this,"visible",{get:function(){return n.visible},set:function(e){n.visible=e}}),Object.defineProperty(this,"canGrow",{get:function(){return n.canGrow},set:function(e){n.canGrow=e}}),Object.defineProperty(this,"newPage",{get:function(){return n.newPage},set:function(e){n.newPage=e}}),Object.defineProperty(this,"ratio",{get:function(){return s},set:function(e){s=e}}),Object.defineProperty(this,"OnFormat",{get:function(){return n.script.OnFormat},set:function(e){n.script.OnFormat=e}}),Object.defineProperty(this,"OnBeforePrint",{get:function(){return n.script.OnBeforePrint},set:function(e){n.script.OnBeforePrint=e}}),Object.defineProperty(this,"OnAfterPrint",{get:function(){return n.script.OnAfterPrint},set:function(e){n.script.OnAfterPrint=e}}),this.propertyNames={name:{cate:"band",info:{type:"string",visible:!0,readonly:!1,defaultValue:"",unique:!0}},height:{cate:"band",info:{type:"number",visible:!0,readonly:!1,defaultValue:""}},dataField:{cate:"band",info:{type:"string",visible:!0,readonly:!1,defaultValue:""}},visible:{cate:"band",info:{type:"boolean",visible:!0,readonly:!1,defaultValue:""}},canGrow:{cate:"band",info:{type:"boolean",visible:!0,readonly:!1,defaultValue:""}},newPage:{cate:"band",info:{type:"select",visible:!0,readonly:!1,defaultValue:"",values:$waiReport.const.defPropSelectValues.newPage}},OnFormat:{cate:"band",info:{type:"script",visible:!0,readonly:!1,defaultValue:""}},OnBeforePrint:{cate:"band",info:{type:"script",visible:!0,readonly:!1,defaultValue:""}},OnAfterPrint:{cate:"band",info:{type:"script",visible:!0,readonly:!1,defaultValue:""}}},this.createBand()};$waiReport.classes.band=_yrBand;var _yrBandCtrl=function(e,t,i){var n=this,r=e,s=i,a=!1,o=t;this.top=-1,this.height=32,this.canvas=null;var h=new $waiReport.classes.eventCtrl;this.init=function(){null==this.canvas&&(this.canvas=document.createElement("canvas")),this.canvas.width=r.formData.pageSetting.paper.width,this.canvas.height=this.height,o.ctrl=n},this.draw=function(e){var t,i,l,c=this.canvas.getContext("2d");try{a=r.designer.selection.hasObject(this)}catch(e){a=!1}if(c.save(),a?(t="#3399ff",i="#ffffff",l="On"):(t="#EAEAEA",i="#000000",l=""),c.fillStyle=t,c.fillRect(0,0,this.canvas.width,this.canvas.height),void 0!==$waiReport.images){var d=null;if(d=s?$waiReport.images.bandCtrl["hide"+l]:$waiReport.images.bandCtrl["show"+l],c.drawImage(d,0,0),!0!==e){var p=d.width,g=d.height;h.add("visibleBtn",d,{l:0,t:0,w:p,h:g},(function(e,t,i,s){if(1===e)n.show=!n.show,r.designer.updateDesign({cmd:"clear"})}))}}c.font=this.height-10+"px Arial",c.textBaseline="middle",c.fillStyle=i,c.textAlign="left",c.fillText(o.name+" : "+o.type,this.height+8,this.height/2),c.fillStyle="#200090",c.textAlign="right";var u=s?"":"[hidden]  ";c.fillText(u+"height : "+o.height,this.canvas.width-8,this.height/2),c.restore()},this.reDraw=function(){this.canvas.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.draw(!0)},this.doProcMouseEvent=function(e,t,i,n){var r=!0;return!0===r&&(r=h.doMouseEvent(e,t,i,n)),r},Object.defineProperty(this,"classType",{get:function(){return"yrBandCtrlClass"}}),Object.defineProperty(this,"show",{get:function(){return s},set:function(e){s=e,r.reDraw()}}),Object.defineProperty(this,"selected",{get:function(){return a},set:function(e){a=e}}),Object.defineProperty(this,"band",{get:function(){return o}}),this.init()},_yrPage=function(e,t){var i=this,n=t;this.bands=[];var r={},s=-1,a=0,o=[];function h(){a=0;for(var t=0;t<i.bands.length;t++)e.showBandCtrl&&(a+=o[t].height),o[t].show&&(a+=i.bands[t].height)}this.canvas=null,this.createPage=function(){null===this.canvas&&(this.canvas=document.createElement("canvas"));var t=getReportObj(this);this.canvas.width=t.info.pageSetting.paper.width;for(var i=n.bands,s=0;s<i.length;s++){var l=new _yrBand(this,i[s]),c=new _yrBandCtrl(e,l,e.showBandCtrl);o.push(c),this.bands.push(l),""!==(l.name+"").trim()&&(r[l.name]=l)}h(),this.canvas.height=a,debug&&console.log("    - CreatePage : ",this.canvas.width,this.canvas.height)},this.Sections=function(e){return r[e]},this.setUpdateSections=function(e){for(var t in r)e?r[t].beginUpdate():r[t].endUpdate()},this.draw=function(t){var i=0,n=this.canvas.getContext("2d");if(void 0!==t);else for(var r=0;r<this.bands.length;r++)e.showBandCtrl&&(o[r].draw(),n.drawImage(o[r].canvas,0,i),o[r].top=i+s,i+=o[r].height),this.bands[r].ctrl.show&&this.bands[r].height>0&&(this.bands[r].draw(),n.drawImage(this.bands[r].canvas,0,i),this.bands[r].top=i+s,i+=this.bands[r].height);return i},this.reDraw=function(){var t=0,i=this.canvas.getContext("2d");i.clearRect(0,0,this.canvas.width,this.canvas.height);for(var n=0;n<this.bands.length;n++)e.showBandCtrl&&(o[n].reDraw(),i.drawImage(o[n].canvas,0,t),o[n].top=t+s,t+=o[n].height),this.bands[n].ctrl.show&&this.bands[n].height>0&&(this.bands[n].reDraw(),i.drawImage(this.bands[n].canvas,0,t),1==this.bands[n].designMD&&i.drawImage(this.bands[n].design,0,t),this.bands[n].top=t+s,t+=this.bands[n].height);return t},this.updateCanvas=function(t){var i=0,n=this.canvas.getContext("2d");n.clearRect(0,0,this.canvas.width,this.canvas.height);for(var r=0;r<this.bands.length;r++)e.showBandCtrl&&(n.drawImage(o[r].canvas,0,i),i+=o[r].height),this.bands[r].ctrl.show&&this.bands[r].height>0&&(n.drawImage(this.bands[r].canvas,0,i),1==this.bands[r].designMD&&n.drawImage(this.bands[r].design,0,i),i+=this.bands[r].height);return null!==e&&e.updateCanvas(t),i},this.updateChild=function(t){var i=0,n=this.canvas.getContext("2d");n.clearRect(0,0,this.canvas.width,this.canvas.height);for(var r=0;r<this.bands.length;r++)this.bands[r].ctrl.show&&this.bands[r].height>0&&(this.bands[r]===t&&(n.drawImage(this.bands[r].canvas,0,i),1==this.bands[r].designMD&&n.drawImage(this.bands[r].design,0,i)),i+=this.bands[r].height),this.bands[r].top=i+s;return null!==e&&e.updateChild(this),i},this.getObjectByXY=function(t,i){var n=null;if(t>=0&&t<=this.canvas.width)for(var r=null,s=0,a=0,o=0,h=0;h<this.bands.length;h++)if(r=this.bands[h],e.showBandCtrl){if(o=(a=s)+r.ctrl.height,a<=i&&o>=i){n=r.ctrl;break}if(r.height>0&&r.ctrl.show&&(o=(a=o)+r.height,a<=i&&o>=i)){n=r,s=a;break}s=o}else if(o=(a=s)+r.ctrl.height,r.height>0){if(o=(a=o)+r.height,a<=i&&o>=i){n=r;break}s=o}else s=o;if(null!==n){var l=null;"yrBandCtrlClass"!==n.classType&&(l=n.getObjectByXY(t,i-s)),null!==l&&(n=l)}return n},this.updateDesign=function(t){var i=0,n=this.canvas.getContext("2d");h(),this.canvas.height=a,n.clearRect(0,0,this.canvas.width,this.canvas.height);for(var r=0;r<this.bands.length;r++)e.showBandCtrl&&(o[r].reDraw(),n.drawImage(o[r].canvas,0,i),i+=o[r].height),this.bands[r].ctrl.show&&this.bands[r].height>0&&(n.drawImage(this.bands[r].canvas,0,i),1==this.bands[r].designMD&&(this.bands[r].updateDesign(t),n.drawImage(this.bands[r].design,0,i)),i+=this.bands[r].height);return i},this.findObjectAtOffsetY=function(t){for(var i=0,n=0;n<this.bands.length;n++){if(e.showBandCtrl){if(rangeCheck(i,this.bands[n].ctrl.height,t))return this.bands[n].ctrl;i+=this.bands[n].ctrl.height}if(this.bands[n].ctrl.show){if(this.bands[n].height>0&&rangeCheck(i,this.bands[n].height,t))return this.bands[n];i+=this.bands[n].height}}return null},this.doProcMouseEvent=function(e,t,i,n){var r=!0,s=this.findObjectAtOffsetY(n);if(null!==s){var a=i,o=n-(s.top-this.top);r=s.doProcMouseEvent(e,t,a,o)}return r},Object.defineProperty(this,"classType",{get:function(){return"yrPageClass"}}),Object.defineProperty(this,"parent",{get:function(){return e}}),Object.defineProperty(this,"info",{get:function(){return n}}),Object.defineProperty(this,"children",{get:function(){return i.bands}}),Object.defineProperty(this,"height",{get:function(){return h(),a}}),Object.defineProperty(this,"top",{get:function(){return s},set:function(e){s=e}}),this.createPage()};$waiReport.classes.page=_yrPage;var _yrReport=function(e,t,i){var n=this,r=[],s=-1;this.formData=null,this.prevLoadedImages=[],this.gridMode=!0,this.gridTick=12,this.dataReHist=[];this.saveRedo=function(){this.dataReHist.push(JSON.parse(JSON.stringify(this.formData)))},this.doRedo=function(){this.dataReHist.length<=0||(this.saveUndo(),this.formData=this.dataReHist.pop(this.formData),this.createReport(),this.draw(),this.updateCanvas({cmd:"Redo"}))},this.dataHist=[];this.saveUndo=function(){this.dataHist.push(JSON.parse(JSON.stringify(this.formData)))},this.doUndo=function(){this.dataHist.length<=0||(this.saveRedo(),this.formData=this.dataHist.pop(this.formData),this.createReport(),this.draw(),this.updateCanvas({cmd:"undo"}))},this.designMode=void 0!==i,this.designer=this.designMode?i:null,this.left=0,this.top=0,this.header=null,this.footer=null,this.zoomOut=2,this.formData=void 0===t?$waiReport.const.newDefaultData():JSON.parse(JSON.stringify(t));var a=!0;this.setShowBandCtrl=function(e){a!==e&&(a=e,this.reDraw())};var o=[];this.canvas=null,this.createReport=function(){debug&&console.time("createReport"),null,s=-1,this.left=0,this.top=0,null!==this.header&&(this.header.clear(),this.header=null),null!==this.footer&&(this.footer.clear(),this.footer=null),this.zoomOut=2;for(var e=0;e<r.length;e++)for(var t=0;t<r[e].children.length;t++)r[e].children[t].clear();r=[],null===this.canvas&&(this.canvas=document.createElement("canvas")),this.canvas.width=this.formData.pageSetting.paper.width;var i=0,n=this.formData.layout;null!==n.reportHeader&&(this.header=new _yrBand(this,n.reportHeader),o.push(new _yrBandCtrl(this,this.header,a)),a&&(i+=o[o.length-1].height),i+=this.header.height),null!==n.reportFooter&&(this.footer=new _yrBand(this,n.reportFooter),o.push(new _yrBandCtrl(this,this.footer,a)),a&&(i+=o[o.length-1].height),i+=this.footer.height);var h=n.pages;for(e=0;e<h.length;e++){var l=new _yrPage(this,h[e]);i+=l.height,r.push(l)}r.length>0&&(r[0],s=0),this.canvas.height=i,debug&&console.log("  - createReport : ",this.canvas.width,this.canvas.height),debug&&console.timeEnd("createReport")},this.draw=function(e){if(void 0!==e);else{var t=0,i=this.canvas.getContext("2d");null!==this.header&&(a&&(this.header.ctrl.draw(),i.drawImage(this.header.ctrl.canvas,0,t),this.header.ctrl.top=t,t+=this.header.ctrl.height),this.header.ctrl.show&&this.header.height>0&&(this.header.draw(),i.drawImage(this.header.canvas,0,t),this.header.top=t,t+=this.header.height));for(var n=0;n<r.length;n++)r[n].top=t,r[n].draw(),i.drawImage(r[n].canvas,0,t),t+=r[n].height;null!==this.footer&&(a&&(this.footer.ctrl.draw(),i.drawImage(this.footer.ctrl.canvas,0,t),this.footer.ctrl.top=t,t+=this.footer.ctrl.height),this.footer.ctrl.show&&this.footer.height>0&&(this.footer.draw(),i.drawImage(this.footer.canvas,0,t),this.footer.top=t,t+=this.footer.height))}return t},this.reDraw=function(){debug&&console.log("  - report : reDraw");var e=0,t=this.canvas.getContext("2d");t.clearRect(0,0,this.canvas.width,this.canvas.height),null!==this.header&&(a&&(this.header.ctrl.reDraw(),t.drawImage(this.header.ctrl.canvas,0,e),this.header.ctrl.top=e,e+=this.header.ctrl.height),this.header.ctrl.show&&this.header.height>0&&(this.header.reDraw(),t.drawImage(this.header.canvas,0,e),this.header.top=e,e+=this.header.height));for(var i=0;i<r.length;i++){r[i].top=e;var n=r[i].reDraw();t.drawImage(r[i].canvas,0,e),e+=n}return null!==this.footer&&(a&&(this.footer.ctrl.reDraw(),t.drawImage(this.footer.ctrl.canvas,0,e),this.footer.ctrl.top=e,e+=this.footer.ctrl.height),this.footer.ctrl.show&&this.footer.height>0&&(this.footer.reDraw(),t.drawImage(this.footer.canvas,0,e),this.footer.top=e,e+=this.footer.height)),e},this.updateCanvas=function(t){debug&&console.log("  - report : updateCanvas");var i=0,n=this.canvas.getContext("2d");n.clearRect(0,0,this.canvas.width,this.canvas.height),null!==this.header&&(a&&(n.drawImage(this.header.ctrl.canvas,0,i),i+=this.header.ctrl.height),this.header.ctrl.show&&this.header.height>0&&(n.drawImage(this.header.canvas,0,i),i+=this.header.height));for(var s=0;s<r.length;s++)n.drawImage(r[s].canvas,0,i),i+=r[s].height;return null!==this.footer&&(a&&(n.drawImage(this.footer.ctrl.canvas,0,i),i+=this.footer.ctrl.height),this.footer.ctrl.show&&this.footer.height>0&&(n.drawImage(this.footer.canvas,0,i),i+=this.footer.height)),null!==e&&e.updateCanvas(t),i},this.getCurrentHeight=function(){var e=0;null!==this.header&&(a&&(e+=this.header.ctrl.height),this.header.ctrl.show&&(e+=this.header.height));for(var t=0;t<r.length;t++){e+=r[t].height}return null!==this.footer&&(a&&(e+=this.footer.ctrl.height),this.footer.ctrl.show&&(e+=this.footer.height)),e},this.updateDesign=function(e){var t=0,i=this.getCurrentHeight();i!==this.canvas.height&&(this.canvas.height=i);var n=this.canvas.getContext("2d");n.clearRect(0,0,this.canvas.width,this.canvas.height),null!==this.header&&(a&&(n.drawImage(this.header.ctrl.canvas,0,t),t+=this.header.ctrl.height),this.header.ctrl.show&&(this.header.height>0&&(n.drawImage(this.header.canvas,0,t),this.header.updateDesign(e),n.drawImage(this.header.design,0,t)),this.header.top=t,t+=this.header.height));for(var s=0;s<r.length;s++){var o=r[s].updateDesign(e);n.drawImage(r[s].canvas,0,t),r[s].top=t,t+=o}return null!==this.footer&&(a&&(n.drawImage(this.footer.ctrl.canvas,0,t),t+=this.footer.ctrl.height),this.footer.ctrl.show&&(this.footer.height>0&&(n.drawImage(this.footer.canvas,0,t),this.footer.updateDesign(e),n.drawImage(this.footer.design,0,t)),this.footer.top=t,t+=this.footer.height)),t},this.updateChild=function(t){var i=0,n=this.canvas.getContext("2d");if(n.clearRect(0,0,this.canvas.width,this.canvas.height),this.header===t&&null!==t)a&&(n.drawImage(this.header.ctrl.canvas,0,i),i+=this.header.ctrl.height),this.header.ctrl.show&&n.drawImage(this.header.canvas,0,i);else if(this.footer===t&&null!==t)a&&(n.drawImage(this.footer.ctrl.canvas,0,i),i+=this.footer.ctrl.height),this.footer.ctrl.show&&n.drawImage(this.footer.canvas,0,i);else{null!==this.header&&(a&&(i+=this.header.ctrl.height),this.header.ctrl.show&&(i+=this.header.height));for(var s=0;s<r.length;s++)r[s]===t&&n.drawImage(r[s].canvas,0,i),i+=r[s].height}return null!==e&&e.updateChild(this),i},this.Sections=function(e){var t=null;return null!==this.header&&this.header.name===e?this.header:null!==this.footer&&this.footer.name===e?this.footer:(void 0!==r[s].Sections(e)&&(t=r[s].Sections(e)),t)},this.setUpdateSections=function(e){null!==this.header&&(e?this.header.beginUpdate():this.header.endUpdate()),null!==this.footer&&(e?this.footer.beginUpdate():this.footer.endUpdate()),void 0!==r[s]&&r[s].setUpdateSections(e)},this.findObjectAtOffsetY=function(e){var t=0;if(null!==this.header){if(a){if(rangeCheck(t,this.header.ctrl.height,e))return this.header.ctrl;t+=this.header.ctrl.height}if(this.header.ctrl.show){if(this.header.height>0&&rangeCheck(t,this.header.height,e))return this.header;t+=this.header.height}}for(var i=0;i<r.length;i++){if(rangeCheck(t,r[i].height,e))return r[i];t+=r[i].height}if(null!==this.footer){if(a){if(rangeCheck(t,this.footer.ctrl.height,e))return this.footer.ctrl;t+=this.footer.ctrl.height}if(this.footer.ctrl.show){if(this.footer.height>0&&rangeCheck(t,this.footer.height,e))return this.footer;t+=this.footer.height}}return null},this.findDataByName=function(e){var t;return t=function e(t,i){if(null==t)return null;var n=null;if(void 0!==t.name&&t.name==i)return t;for(var r in t)if(typeof t[r]==typeof{}&&null!==(n=e(t[r],i)))break;return n}(this.formData,e),t},this.newNameOfType=function(e){for(var t=null,i=1;i<1e5;i++)if(null===(t=this.findDataByName(e+""+i))){t=e+""+i;break}return t},this.doProcMouseEvent=function(e,t){var i=!0,n=t.offsetX*this.zoomOut,r=t.offsetY*this.zoomOut,s=this.findObjectAtOffsetY(r);if(null!==s){var a=n,o=r-s.top;i=s.doProcMouseEvent(e,t,a,o)}return i},this.getObjectByXY=function(e,t){var i,n=this.left+Math.round(e*this.zoomOut),o=this.top+Math.round(t*this.zoomOut),h=null,l=0,c=0,d=0;null!==this.header&&(i=this.header,a&&(c=(l=d)+i.ctrl.height,l<=o&&c>=o?h=i.ctrl:i.height>0&&i.ctrl.show?(c=(l=c)+i.height,l<=o&&c>=o?h=i:d=c):d=c));var p=null;return null!==h?"yrBandCtrlClass"!==h.classType&&null!==(p=h.getObjectByXY(n,o-l))?p:h:(d=c,null!==(h=r[s].getObjectByXY(n,o-d))?h:(d+=r[s].height,null!==this.footer&&(i=this.footer,a&&(c=(l=d)+i.ctrl.height,l<=o&&c>=o?h=i.ctrl:i.height>0&&i.ctrl.show?(c=(l=c)+i.height,l<=o&&c>=o?h=i:d=c):d=c)),null!==h&&"yrBandCtrlClass"!==h.classType&&null!==(p=h.getObjectByXY(n,o-l))?p:h))},this.loadFormData=function(e){this.formData=e,this.createReport(),this.draw()},Object.defineProperty(this,"classType",{get:function(){return"yrReportClass"}}),Object.defineProperty(this,"parent",{get:function(){return e}}),Object.defineProperty(this,"pages",{get:function(){return r}}),Object.defineProperty(this,"pageCount",{get:function(){return r.length}}),Object.defineProperty(this,"pageIndex",{get:function(){return s},set:function(e){var t=e;if("string"==typeof t?t=parseInt(t):"number"!=typeof t&&(t=NaN),NaN!==t){var i=new Error;if(console.error('yrReport.pageIndex value is wrong number "'+t+'"',i),raiseThrow)throw i}else if(t<0||t>r.length-1){i=new Error;if(console.error("yrReport.pageIndex value is out of range (",t,")",i),raiseThrow)throw i}else s=e,r[pIdx]}}),Object.defineProperty(this,"info",{get:function(){return n.formData}}),Object.defineProperty(this,"children",{get:function(){return this.Pages}}),Object.defineProperty(this,"showBandCtrl",{get:function(){return a},set:function(e){var t="YES"==(e+"").toUpperCase()||"TRUE"==(e+"").toUpperCase()||!0===e;n.setShowBandCtrl(t)}});var h=!1;Object.defineProperty(this,"showOutline",{get:function(){return h},set:function(e){h!=e&&(h=e)}}),this.createReport()};$waiReport.classes.report=_yrReport;var _yrDesSelection=function(argDesigner){this.zoom=2,this.items=[],this.pos=[],this.minX=-1,this.maxX=-1,this.minY=-1,this.maxY=-1,this.absTop=0,this.absWidth=0,this.absHeight=0;var designer=void 0===argDesigner?null:argDesigner;this.gridMode=!0,this.gridTick=12,this.getSelItems=function(){return this.items},this.genPosition=function(){if(this.pos=[],this.minX=9999999,this.maxX=0,this.minY=9999999,this.maxY=0,!(this.items.length<=0)){"yrComponentClass"===this.items[0].classType?(this.absTop=this.items[0].parent.top,this.absWidth=this.items[0].parent.report.canvas.width,this.absHeight=this.items[0].parent.height):"yrBandCtrlClass"===this.items[0].classType&&(this.absTop=this.items[0].band.top,this.absWidth=this.items[0].band.canvas.width,this.absHeight=this.items[0].band.canvas.height);for(var e=0;e<this.items.length;e++)if("line"!==this.items[e].type)"yrComponentClass"===this.items[0].classType?(this.minX=Math.min(this.minX,this.items[e].left),this.maxX=Math.max(this.maxX,this.items[e].left+this.items[e].width),this.minY=Math.min(this.minY,this.items[e].top),this.maxY=Math.max(this.maxY,this.items[e].top+this.items[e].height),this.pos.push({x:this.items[e].left,y:this.items[e].top,w:this.items[e].width,h:this.items[e].height})):"yrBandCtrlClass"===this.items[0].classType&&(this.minX=Math.min(this.minX,0),this.maxX=Math.max(this.maxX,this.items[e].canvas.width),this.minY=Math.min(this.minY,this.items[e].top),this.maxY=Math.max(this.maxY,this.items[e].top+this.items[e].canvas.height),this.pos.push({x:0,y:this.items[0].band.top,w:this.items[0].band.canvas.width,h:this.items[0].band.canvas.height}));else if("yrComponentClass"===this.items[0].classType){var t=Math.min(this.items[e].x1,this.items[e].x2),i=Math.min(this.items[e].y1,this.items[e].y2),n=Math.max(this.items[e].x1,this.items[e].x2),r=Math.max(this.items[e].y1,this.items[e].y2);this.minX>t&&(this.minX=t),this.maxX<n&&(this.maxX=n),this.minY>i&&(this.minY=i),this.maxY<r&&(this.maxY=r),this.pos.push({x:this.items[e].x1,y:this.items[e].y1,w:this.items[e].x2,h:this.items[e].y2})}}};var SDPos=[],FXPos={x:0,y:0};this.moved=!1,this.resized=!1,this.startDrag=function(e,t){this.moved=!1,FXPos.x=e,FXPos.y=t,SDPos=[];for(var i=0;i<this.pos.length;i++)SDPos.push({x:this.pos[i].x,y:this.pos[i].y,w:this.pos[i].w,h:this.pos[i].h})},this.bgCanSize=function(){var e=$("#reportCanvasBg"),t=$("#reportCanvas"),i=navigator.userAgent.toLowerCase();"Netscape"==navigator.appName&&-1!=navigator.userAgent.search("Trident")||-1!=i.indexOf("msie")||(e[0].width=t[0].width/this.zoom+1),e[0].height=t[0].height/this.zoom+250},this.createProperiesObject=function(selPropChange){var _ppObj=function(items,spvChange){for(var self=this,names={},n=null,sItems=items,propNames=null,curItem=null,pInfo=null,pVal="",i=0,cp;i<items.length;i++){debug&&console.log("  [",items[i].name,"]----------------------");try{curItem="yrBandCtrlClass"==items[i].classType?items[i].band:items[i],propNames=JSON.parse(JSON.stringify(curItem.propertyNames))}catch(e){}if(0==i){for(n in propNames)!0===propNames[n].info.visible&&(pInfo=propNames[n].info,pVal=void 0===pInfo.link?curItem[n]:eval("curItem."+pInfo.link),names[n]={value:pVal,diffe:!1,cate:propNames[n].cate,info:propNames[n].info});debug&&console.log("    - Style Object : ",curItem.style)}else for(n in names)void 0===propNames[n]?delete names[n]:(pInfo=propNames[n].info,pVal=void 0===pInfo.link?curItem[n]:eval("curItem."+pInfo.link),names[n].diffe=names[n].value!==pVal,names[n].value=1==names[n].diffe?"":names[n].value,names[n].info.readonly=1==names[n].info.unique)}for(n in this.valueChanged=function(nm,nv){if(!(sItems.length<=0)){var band="yrBandCtrlClass"==sItems[0].classType?sItems[0].band:sItems[0].parent;null!==designer&&designer.report.saveUndo(),band.beginUpdate();for(var i=0;i<sItems.length;i++){var curItem="yrBandCtrlClass"==sItems[i].classType?sItems[i].band:sItems[i];if(void 0!==names[nm].info.link){var eTxt="curItem."+names[nm].info.link+" = nv;";eval(eTxt)}else{var value=void 0;value="number"==names[nm].info.type?parseInt((nv+"").trim()):"float"==names[nm].info.type?1==isNaN(parseFloat((nv+"").trim()))?0:parseFloat((nv+"").trim()):nv,curItem[nm]=value}names[nm].value=curItem[nm],"qrcode"===sItems[i].type&&(sItems[i].height=sItems[i].width)}band.endUpdate(),band.reDraw(),null!==designer&&(designer.updateChild(),designer.updateDesign({cmd:"clear"}),designer.fireOnChangedForm()),void 0!==spvChange&&spvChange(nm,nv,this)}},this.__defCompProp=function(pNm,cp){var pDefS='Object.defineProperty(this,"'+pNm+'",{\n',pDefE="\n});",pGet='get : function() { return names["'+pNm+'"]; }',pSet='set : function(v){ names["'+pNm+'"].value = v; this.valueChanged("'+pNm+'",v); }',evalStr="";evalStr=cp.readonly?pDefS+pGet+pDefE:pDefS+pGet+",\n"+pSet+pDefE,eval(evalStr)},names)cp=names[n].info,this.__defCompProp(n,cp);this.attr=names},ppObj=new _ppObj(this.items,selPropChange);return ppObj},this.allObjSum=function(e){for(var t=e[0].y,i=e[0].x,n=e[0].w,r=e[0].h,s=t+r,a=i+n,o=1;o<e.length;o++){var h=e[o].y,l=e[o].x,c=l+e[o].w,d=h+e[o].h;t>h&&(t=h),i>l&&(i=l),a<c&&(a=c),s<d&&(s=d)}return{h:r=s-t,w:n=a-i,x:i,y:t}};var guideLinePointV=[],guideLinePointH=[];this.resetGuideLinePointV=function(){guideLinePointV=[]},this.resetGuideLinePointH=function(){guideLinePointH=[]},this.drawGuideLinePoint=function(){var e=document.getElementById("reportCanvas").getContext("2d");e.fillStyle="blue";for(var t=0;t<guideLinePointV.length;t++)guideLinePointV[t].h<0?e.fillRect(guideLinePointV[t].x,guideLinePointV[t].y2,guideLinePointV[t].w,guideLinePointV[t].h2):e.fillRect(guideLinePointV[t].x,guideLinePointV[t].y,guideLinePointV[t].w,guideLinePointV[t].h);for(t=0;t<guideLinePointH.length;t++)guideLinePointH[t].w<guideLinePointH[t].x?e.fillRect(guideLinePointH[t].x2,guideLinePointH[t].y,guideLinePointH[t].w2,guideLinePointH[t].h):e.fillRect(guideLinePointH[t].x,guideLinePointH[t].y,guideLinePointH[t].w,guideLinePointH[t].h)},this.allSumPlusH=function(e,t){var i=0;for(var n in e)for(var r=0;r<e[n].length;r++){if(t.name==e[n][r].name&&t.type==e[n][r].type)return i;i+=e[n][r].allHeight}return i},this.allHSetting=function(e){var t=e.pages[0].bands,i=e.reportHeader,n=e.reportFooter,r={rptHead:[],pageHead:[],groupHead:[],detail:[],groupFoot:[],pageFoot:[],rptFoot:[]},s=32;null!=i&&"reportHeader"==i.type&&r.rptHead.push({name:i.name,type:i.type,allHeight:i.height+s});for(var a=0;a<t.length;a++)"pageHeader"==t[a].type?r.pageHead.push({name:t[a].name,type:t[a].type,allHeight:t[a].height+s}):"groupHeader"==t[a].type?r.groupHead.push({name:t[a].name,type:t[a].type,allHeight:t[a].height+s}):"detail"==t[a].type?r.detail.push({name:t[a].name,type:t[a].type,allHeight:t[a].height+s}):"groupFooter"==t[a].type?r.groupFoot.push({name:t[a].name,type:t[a].type,allHeight:t[a].height+s}):"pageFooter"==t[a].type&&r.pageFoot.push({name:t[a].name,type:t[a].type,allHeight:t[a].height+s});return null!=n&&"reportFooter"==n.type&&r.rptFoot.push({name:n.name,type:n.type,allHeight:n.height+s}),r},this.searchGuideLine=function(e,t,i){var n=this.items[0].parent.name,r=this.items[0].parent.type;if(null!=t)for(var s=this.allHSetting(i),a=0;a<t.length;a++){if(e.x==t[a].obj.left||e.x==t[a].obj.left+t[a].obj.width){var o=this.allSumPlusH(s,t[a].band),h=this.allSumPlusH(s,this.items[0].band);guideLinePointV.push({x:e.x,y:e.y+h+32,w:2,h:t[a].obj.top+t[a].obj.height+o-(e.y+h),y2:t[a].obj.top+o+32,h2:e.y+e.h+h-(t[a].obj.top+o)})}if(e.x+e.w==t[a].obj.left||e.x+e.w==t[a].obj.left+t[a].obj.width){o=this.allSumPlusH(s,t[a].band),h=this.allSumPlusH(s,this.items[0].band);guideLinePointV.push({x:e.x+e.w,y:e.y+h+32,w:2,h:t[a].obj.top+t[a].obj.height+o-(e.y+h),y2:t[a].obj.top+o+32,h2:e.y+e.h+h-(t[a].obj.top+o)})}if(t[a].band.name==n&&t[a].band.type==r){if(e.y==t[a].obj.top||e.y==t[a].obj.top+t[a].obj.height){o=this.allSumPlusH(s,t[a].band);guideLinePointH.push({x:e.x,y:e.y+32+o,w:t[a].obj.left+t[a].obj.width-e.x,h:2,x2:t[a].obj.left,w2:e.x+e.w-t[a].obj.left})}if(e.y+e.h==t[a].obj.top||e.y+e.h==t[a].obj.top+t[a].obj.height){o=this.allSumPlusH(s,t[a].band);guideLinePointH.push({x:e.x,y:e.y+e.h+32+o,w:t[a].obj.left+t[a].obj.width-e.x,h:2,x2:t[a].obj.left,w2:e.x+e.w-t[a].obj.left})}}}},this.guideLine=function(e,t,i){var n=designer.getRptInfo().formData.layout,r=n.pages[0].bands,s=n.reportHeader,a=n.reportFooter,o=[];function h(e){for(var t=0;t<e.objects.length;t++)o.push({band:e,obj:e.objects[t]})}null!=s&&null!=s.objects&&h(s),null!=a&&null!=a.objects&&h(a);for(var l=0;l<r.length;l++)("pageHeader"==r[l].type||"groupHeader"==r[l].type||"detail"==r[l].type||"groupFooter"==r[l].type||"pageFooter"==r[l].type)&&h(r[l]);this.searchGuideLine(i,o,n)},this.doDragMove=function(e,t){var i=(e-FXPos.x)*this.zoom,n=(t-FXPos.y)*this.zoom,r=this.minX+i,s=this.minY+n,a=this.maxX+i,o=this.maxY+n;if(this.gridMode){var h=r%this.gridTick,l=s%this.gridTick;h>=Math.floor(this.gridTick/2)?(r+=this.gridTick-h,a+=this.gridTick-h,i+=this.gridTick-h):(r-=h,a-=h,i-=h),l>=Math.floor(this.gridTick/2)?(s+=this.gridTick-l,o+=this.gridTick-l,n+=this.gridTick-l):(s-=l,o-=l,n-=l)}r<0&&(i-=r),s<0&&(n-=s),a>this.absWidth&&(i=this.absWidth-this.maxX-1*this.zoom),o>this.absHeight&&(n=this.absHeight-this.maxY-1*this.zoom);var c;c=this.allObjSum(this.pos);for(var d=0;d<this.pos.length;d++)"line"!==this.items[d].type?(this.pos[d].x=SDPos[d].x+i,this.pos[d].y=SDPos[d].y+n,event.ctrlKey&&this.guideLine(i,n,c)):(this.pos[d].x=SDPos[d].x+i,this.pos[d].y=SDPos[d].y+n,this.pos[d].w=SDPos[d].w+i,this.pos[d].h=SDPos[d].h+n);this.moved=!0},this.doDragLine=function(e,t,i,n,r){this.pos=[];var s=e*this.zoom-n,a=t*this.zoom-r;a-=this.items[0].parent.top;var o=this.items[0],h=o.x1,l=o.y1,c=o.x2,d=o.y2;function p(e,t){var i=t%e;return i>=e/2?t+(e-i):t-i}switch(i){case 0:h+=s,h=p(this.gridTick,h),l+=a,l=p(this.gridTick,l);break;case 1:c+=s,c=p(this.gridTick,c),d+=a,d=p(this.gridTick,d)}this.pos.push({x:h,y:l,w:c,h:d})},this.doDragResize=function(e,t,i,n){var r,s=24,a=(e-FXPos.x)*this.zoom,o=(t-FXPos.y)*this.zoom;r=this.allObjSum(this.pos);for(var h=0;h<this.pos.length;h++){var l=SDPos[h].x,c=SDPos[h].y,d=SDPos[h].w,p=SDPos[h].h,g=i.split("-")[0].toUpperCase();if(event.ctrlKey&&this.guideLine(a,o,r),g.indexOf("N")>=0){if(c=SDPos[h].y+o,p=SDPos[h].h-o,this.gridMode){var u=c%this.gridTick;u>=this.gridTick/2?(c+=this.gridTick-u,p-=this.gridTick-u):(c-=u,p+=u)}p<s&&(c=SDPos[h].y+(SDPos[h].h-s),p=s),"qrcode"===this.items[h].type&&(this.pos[h].x=l,this.pos[h].y=c,this.pos[h].w=p,this.pos[h].h=p)}if(g.indexOf("S")>=0){if(p=SDPos[h].h+o,this.gridMode){var f=p%this.gridTick;f>=this.gridTick/2?p+=this.gridTick-f:p-=f}p<s&&(p=s),"qrcode"===this.items[h].type&&(this.pos[h].x=l,this.pos[h].y=c,this.pos[h].w=p,this.pos[h].h=p)}if(g.indexOf("W")>=0){if(l=SDPos[h].x+a,d=SDPos[h].w-a,this.gridMode){var m=l%this.gridTick;m>=this.gridTick/2?(l+=this.gridTick-m,d-=this.gridTick-m):(l-=m,d+=m)}d<s&&(l=SDPos[h].x+(SDPos[h].w-s),d=s),"qrcode"===this.items[h].type&&(this.pos[h].x=l,this.pos[h].y=c,this.pos[h].w=d,this.pos[h].h=d)}if(g.indexOf("E")>=0){if(d=SDPos[h].w+a,this.gridMode){var v=d%this.gridTick;v>=this.gridTick/2?d+=this.gridTick-v:d-=v}d<s&&(d=s),"qrcode"===this.items[h].type&&(this.pos[h].x=l,this.pos[h].y=c,this.pos[h].w=d,this.pos[h].h=d)}"qrcode"!==this.items[h].type&&(this.pos[h].x=l,this.pos[h].y=c,this.pos[h].w=d,this.pos[h].h=p)}this.moved=!0},this.doResizeUnit=function(e){if(!(this.items.length<=0)&&"yrComponentClass"===this.items[0].classType){this.genPosition();var t=this.items[0].parent,i=e[0],n=e[1],r=this.minX+i,s=this.minY+n,a=this.maxX+i,o=this.maxY+n;r<0&&(i-=r),s<0&&(n-=s),a>this.absWidth&&(i=this.absWidth-this.maxX-1*this.zoom),o>this.absHeight&&(n=this.absHeight-this.maxY-1*this.zoom),t.beginUpdate();for(var h=0;h<this.items.length;h++){var l=this.items[h];"line"!==this.items[h].type?-1!=i&&-5!=i||0!=n?0!=i||-1!=n&&-5!=n?1!=i&&5!=i||0!=n?0!=i||1!=n&&5!=n||(l.left=l.left,l.top=l.top,l.width=l.width,l.height=l.height+n):(l.left=l.left,l.top=l.top,l.width=l.width+i,l.height=l.height):(l.left=l.left,l.top=l.top,l.width=l.width,l.height=l.height+n):(l.left=l.left,l.top=l.top,l.width=l.width+i,l.height=l.height):(l.x1=l.x1+i,l.y1=l.y1+n,l.x2=l.x2+i,l.y2=l.y2+n)}t.endUpdate(),t.reDraw()}},this.doMoveUnit=function(e){if(!(this.items.length<=0)&&"yrComponentClass"===this.items[0].classType){this.genPosition();var t=this.items[0].parent,i=e[0],n=e[1],r=this.minX+i,s=this.minY+n,a=this.maxX+i,o=this.maxY+n;r<0&&(i-=r),s<0&&(n-=s),a>this.absWidth&&(i=this.absWidth-this.maxX-1*this.zoom),o>this.absHeight&&(n=this.absHeight-this.maxY-1*this.zoom),t.beginUpdate();for(var h=0;h<this.items.length;h++){var l=this.items[h];"line"!==this.items[h].type?(l.left=l.left+i,l.top=l.top+n):(l.x1=l.x1+i,l.y1=l.y1+n,l.x2=l.x2+i,l.y2=l.y2+n)}t.endUpdate(),t.reDraw()}},this.endDrag=function(){if(SDPos=[],FXPos={x:0,y:0},!(this.items.length<=0)){if("yrComponentClass"===this.items[0].classType){var e=this.items[0].parent;if(1==this.moved){e.beginUpdate(),e.report.saveUndo();for(var t=0;t<this.items.length;t++){var i=this.items[t];"line"!==i.type?(i.left=this.pos[t].x,i.top=this.pos[t].y,i.width=this.pos[t].w,i.height=this.pos[t].h):(i.x1=this.pos[t].x,i.y1=this.pos[t].y,i.x2=this.pos[t].w,i.y2=this.pos[t].h)}e.endUpdate(),e.reDraw()}else e.reDraw()}this.firePropertyChange(),designer.fireOnChangedForm()}},this.new=function(e){return this.items=[],"yrBandClass"===e.classType?this.items.push(e.ctrl):("qrcode"===e.type&&(e.height=e.width),this.items.push(e)),this.genPosition(),this.firePropertyChange(),!0},this.firePropertyChange=function(){void 0!==this._changedSelection&&this._changedSelection(this.createProperiesObject(this._selectionPropChn))},this.add=function(e){var t=!1,i=this.indexOf(e);if(i>=0)this.items.splice(i,1),t=!0;else{if(0==this.items.length||"yrBandCtrlClass"===e.classType)return this.new(e);var n=this.items[this.items.length-1];if("yrBandCtrlClass"===n.classType)return this.new(e);if("yrComponentClass"===n.classType&&"yrBandClass"!==e.classType){if(n.parent!==e.parent)return this.new(e);this.items.push(e),t=!0}}return this.genPosition(),t&&void 0!==this._changedSelection&&this._changedSelection(this.createProperiesObject(this._selectionPropChn)),t},this.areaSelect=function(e,t,i,n,r,s){!0!==s&&(this.items=[]);for(var a=e.children,o=[Math.min(t,n),Math.min(i-e.top,r-e.top),Math.max(t,n),Math.max(i-e.top,r-e.top)],h=[],l={x:0,y:0},c=0;c<a.length;c++){var d=a[c];h="line"!==d.type?[d.left,d.top,d.left+d.width,d.top+d.height]:[d.x1,d.y1,d.x2,d.y2],l.x=(h[0]+h[2])/2,l.y=(h[1]+h[3])/2,(h[0]<=o[0]&&h[2]>=o[0]&&h[1]<=o[1]&&h[3]>=o[1]||h[0]<=o[2]&&h[2]>=o[2]&&h[1]<=o[3]&&h[3]>=o[3]||o[0]<=h[0]&&o[2]>=h[0]&&o[1]<=h[1]&&o[3]>=h[1]||o[0]<=h[2]&&o[2]>=h[2]&&o[1]<=h[3]&&o[3]>=h[3]||o[0]<=h[0]&&o[2]>=h[0]&&o[1]<=h[3]&&o[3]>=h[3]||o[0]<=h[2]&&o[2]>=h[2]&&o[1]<=h[1]&&o[3]>=h[1]||o[0]<=l.x&&o[2]>=l.x&&h[1]<=o[1]&&h[3]>=o[3]||o[1]<=l.y&&o[3]>=l.y&&h[0]<=o[0]&&h[2]>=o[2])&&this.items.push(d)}return this.genPosition(),void 0!==this._changedSelection&&this._changedSelection(this.createProperiesObject(this._selectionPropChn)),!0},this._changedSelection=void 0,this._selectionPropChn=void 0,this.clear=function(){this.items=[],SDPos=[],FXPos={x:0,y:0},this.moved=!1,this.resized=!1,this.genPosition()},this.hasObject=function(e){for(var t=!1,i=0;i<this.items.length;i++)if(e===this.items[i]){t=!0;break}return t},this.indexOf=function(e){for(var t=-1,i=0;i<this.items.length;i++)if(e===this.items[i]){t=i;break}return t}},_yrReportDesigner=function(repFormData,viewCanvas,keyCtrlElem,callback){var self=this,zoom=2,FXPos={obj:null,x:0,y:0},_formData=repFormData;this.viewCanvas=viewCanvas,this.selection=new _yrDesSelection(this),this.canvas=null;var canv=this.viewCanvas,rpt=null,resizeKeyDown=!1,moveKeyDown=!1,showDesignCanvas=!1,showCompOL=!0,_gridMode=!0,_gridTick=12,_InsertMode=!1,_newCompType="",_newCompRect={x1:0,y1:0,x2:0,y2:0},_onSelectionChange=void 0;this._changedSelection=function(e){void 0!==_onSelectionChange&&_onSelectionChange(self.selection,e)},this._selectionPropChn=function(e,t,i){rpt.updateChild(null)},this.selection._selectionPropChn=this._selectionPropChn,this.selection._changedSelection=this._changedSelection,this.onChangedForm=null,this.fireOnChangedForm=function(){null!==this.onChangedForm&&this.onChangedForm()},this.init=function(e){null===this.canvas&&(this.canvas=document.createElement("canvas")),this.setShowDesignCanvas(!1),(rpt=new $waiReport.classes.report(this,_formData,this)).showOutline=showCompOL;var t=$("#reportCanvasBg")[0];void 0!==t&&(this.assignBgCanvas(t),this.assignMenuEvent(),this.assignMenuClickEvent()),this.assignCanvas(canv),canv.width=rpt.canvas.width,canv.height=rpt.canvas.height,canv.style.width=Math.floor(canv.width/zoom)+"px",canv.style.height=Math.floor(canv.height/zoom)+"px",this.preventLoadImages((function(){rpt.draw();var t=canv.getContext("2d");t.clearRect(0,0,canv.width,canv.height),t.drawImage(rpt.canvas,0,0),null!=e&&e(self)}))},this.createBgCan=function(){var e=$("#reportCanvas"),t=($("#designDiv"),document.createElement("canvas")),i=(t.getContext("2d"),navigator.userAgent.toLowerCase()),n="Netscape"==navigator.appName&&-1!=navigator.userAgent.search("Trident")||-1!=i.indexOf("msie");t.width=n?e[0].width:e[0].width/zoom+1,t.height=e[0].height/zoom+250,t.id="reportCanvasBg",t.style.position="absolute",t.style.backgroundColor="rgba(10, 10, 10, 0.2)",t.style.zIndex=-1,e.before(t),this.assignBgCanvas(t),this.assignMenuEvent(),this.assignMenuClickEvent()},this.loadData=function(e){_gridMode=!0,_gridTick=12,showCompOL=!0,_InsertMode=!1,dragST=!1,dragType="",_formData=e,rpt.formData=JSON.parse(JSON.stringify(_formData)),debug&&console.log("reportDesigner.loadData : ",rpt.formData),rpt.createReport(),canv.width=rpt.canvas.width,canv.height=rpt.canvas.height,canv.style.width=Math.floor(canv.width/zoom)+"px",canv.style.height=Math.floor(canv.height/zoom)+"px",this.preventLoadImages((function(){rpt.draw();var e=canv.getContext("2d");e.clearRect(0,0,canv.width,canv.height),e.drawImage(rpt.canvas,0,0),self.createBgCan()}))},this.preventLoadImages=function(e){var t=rpt.pageCount>0?rpt.pages[0]:null;if(null!==t){var i=0;rpt.prevLoadedImages=[];var n=[];o(rpt.header);for(var r=0;r<t.bands.length;r++)o(t.bands[r]);if(o(rpt.footer),0==n.length)e();else{i=n.length;for(var s=0;s<n.length;s++){var a={name:n[s].name,img:null};a.img=new Image,a.img.onload=function(){--i<=0&&e()},a.img.src=n[s].data,rpt.prevLoadedImages.push(a)}}}function o(e){if(null!=e)for(var t=0;t<e.objects.length;t++){var i=e.objects[t];if("image"===i.type){if(void 0===i.data||i.data.length<=0)continue;n.push(i)}}}},this.setShowDesignCanvas=function(e){showDesignCanvas!==e&&(showDesignCanvas=e)&&(this.canvas.width=rpt.canvas.width,this.canvas.height=rpt.canvas.height)},this.allSelect=function(){if(this.selection.items.length<1)return!1;var e=this.selection.items,t=null;"yrComponentClass"==e[0].classType&&(t=e[0].parent);var i=null!==t?t:"yrBandCtrlClass"==e[0].classType?e[0].band:e[0];this.selection.clear();for(var n=i.objects,r=0;r<n.length;r++)this.selection.add(n[r]);this.updateChild(null)},this.selectAreaRect=function(e,t){var i=FXPos.obj;if(null!==i)for(;"yrBandClass"!=i.classType&&null!=(i=i.parent););if(null==i)return!1;this.selection.areaSelect(i,FXPos.x,FXPos.y,e,t)},this.updateCanvas=function(e){var t=canv.getContext("2d");t.clearRect(0,0,canv.width,canv.height),t.drawImage(rpt.canvas,0,0),showDesignCanvas&&t.drawImage(this.canvas,0,0)},this.updateChild=function(e){rpt.reDraw();var t=canv.getContext("2d");t.clearRect(0,0,canv.width,canv.height),t.drawImage(rpt.canvas,0,0),showDesignCanvas&&t.drawImage(this.canvas,0,0)},this.updateDesign=function(e){var t=rpt.updateDesign(e);canv.height!==t&&(canv.height=t,canv.style.height=Math.floor(canv.height/zoom)+"px");var i=canv.getContext("2d");i.clearRect(0,0,canv.width,canv.height),i.drawImage(rpt.canvas,0,0),showDesignCanvas&&i.drawImage(this.canvas,0,0)},this.getRptInfo=function(){return rpt};var dragST=!1,dragType="",dragLinePt=-1,sizeMC=["nw-resize","ne-resize","sw-resize","se-resize","w-resize","e-resize","n-resize","s-resize"];this.changeMouseCursor=function(e,t){var i="";if(this.selection.items.length>0)if("yrComponentClass"===this.selection.items[0].classType){t-=this.selection.absTop;for(var n="",r=0;r<this.selection.pos.length;r++){var s=this.selection.items[r];if("line"!==s.type){var a=this.selection.pos[r],o=$waiReport.rtl.drawing.checkResizeRect([a.x,a.y,a.w,a.h],e,t);if(o>=0){n=sizeMC[o];break}}else(dragLinePt=linePointCheck(s,e,t))>=0&&(n="Crosshair")}if(""!==n)canv.style.cursor=n,i="resize";else if(rangeCheck2(this.selection.minX,this.selection.maxX,e)&&rangeCheck2(this.selection.minY,this.selection.maxY,t)){var h=!1;for(r=0;r<this.selection.pos.length;r++){var l=this.selection.pos[r];if("line"!==this.selection.items[r].type){if(rangeCheck(l.x,l.w,e)&&rangeCheck(l.y,l.h,t)){h=!0;break}}else{var c={x:l.x,y:l.y},d={x:l.w,y:l.h},p={x:e,y:t},g=void 0===this.selection.items[r].lineWeight?2:parseInt(this.selection.items[r].lineWeight);if(g=NaN===g?2:g,g+=10,$waiReport.rtl.util.checkLinePoint(c,d,p,g)){h=!0;break}}}canv.style.cursor=h?"pointer":"default",i=h?"move":""}else canv.style.cursor="default"}else if("yrBandCtrlClass"===this.selection.items[0].classType){if(null==this.selection.items[0].band.canvas)return;var u=this.selection.items[0].band.top,f=this.selection.items[0].band.canvas.width,m=this.selection.items[0].band.canvas.height;canv.getContext("2d");e>=0&&e<=0+f&&t>=u+m-15&&t<=u+m-2?(i="bandSize",canv.style.cursor="s-resize"):canv.style.cursor="default"}return i},this.assignMenuClickEvent=function(){$("#insert_group").bind("mousedown",(function(e){self.doMenuProcMouseClickEvent(0,e)})),$("#insert_page").bind("mousedown",(function(e){$("#pageTxt")[0].disable||self.doMenuProcMouseClickEvent(1,e)})),$("#insert_report").bind("mousedown",(function(e){$("#reportTxt")[0].disable||self.doMenuProcMouseClickEvent(2,e)})),$("#delSection_menu").bind("mousedown",(function(e){$("#delSelTxt")[0].disable||self.doMenuProcMouseClickEvent(3,e)})),$("#cut_menu").bind("mousedown",(function(e){$("#cutTxt")[0].disable||self.doMenuProcMouseClickEvent(4,e)})),$("#copy_menu").bind("mousedown",(function(e){$("#copyTxt")[0].disable||self.doMenuProcMouseClickEvent(5,e)})),$("#paste_menu").bind("mousedown",(function(e){$("#pasteTxt")[0].disable||self.doMenuProcMouseClickEvent(6,e)})),$("#delete_menu").bind("mousedown",(function(e){$("#deleteTxt")[0].disable||self.doMenuProcMouseClickEvent(7,e)}))},this.assignMenuEvent=function(){$("#cut_menu").bind("mouseover",(function(e){$("#cutTxt")[0].disable||self.doMenuProcMouseEvent(0,e)})),$("#cut_menu").bind("mouseout",(function(e){self.doMenuProcMouseEvent(1,e)})),$("#copy_menu").bind("mouseover",(function(e){$("#copyTxt")[0].disable||self.doMenuProcMouseEvent(2,e)})),$("#copy_menu").bind("mouseout",(function(e){self.doMenuProcMouseEvent(3,e)})),$("#paste_menu").bind("mouseover",(function(e){$("#pasteTxt")[0].disable||self.doMenuProcMouseEvent(4,e)})),$("#paste_menu").bind("mouseout",(function(e){self.doMenuProcMouseEvent(5,e)})),$("#delete_menu").bind("mouseover",(function(e){$("#deleteTxt")[0].disable||self.doMenuProcMouseEvent(6,e)})),$("#delete_menu").bind("mouseout",(function(e){self.doMenuProcMouseEvent(7,e)})),$("#insert_menu").bind("mouseover",(function(e){self.doMenuProcMouseEvent(8,e)})),$("#insert_menu").bind("mouseout",(function(e){self.doMenuProcMouseEvent(9,e)})),$("#insert_group").bind("mouseover",(function(e){self.doMenuProcMouseEvent(10,e)})),$("#insert_group").bind("mouseout",(function(e){self.doMenuProcMouseEvent(11,e)})),$("#insert_page").bind("mouseover",(function(e){$("#pageTxt")[0].disable||self.doMenuProcMouseEvent(12,e)})),$("#insert_page").bind("mouseout",(function(e){self.doMenuProcMouseEvent(13,e)})),$("#insert_report").bind("mouseover",(function(e){$("#reportTxt")[0].disable||self.doMenuProcMouseEvent(14,e)})),$("#insert_report").bind("mouseout",(function(e){self.doMenuProcMouseEvent(15,e)})),$("#delSection_menu").bind("mouseover",(function(e){$("#delSelTxt")[0].disable||self.doMenuProcMouseEvent(16,e)})),$("#delSection_menu").bind("mouseout",(function(e){self.doMenuProcMouseEvent(17,e)}))},this.assignBgCanvas=function(e){$(e).bind("mousemove",(function(e){self.doBcanProcMouseEvent(0,e)})),$(e).bind("mouseup",(function(e){self.doBcanProcMouseEvent(1,e)}))},this.assignCanvas=function(e){$(e).bind("mousemove",(function(e){self.doProcMouseEvent(0,e)})),$(e).bind("mousedown",(function(e){self.doProcMouseEvent(1,e)})),$(e).bind("mouseup",(function(e){self.doProcMouseEvent(2,e)})),null!=keyCtrlElem&&$(document).bind("keydown",(function(e){self.doProcKeyEvent(0,e)})),null!=keyCtrlElem&&$(document).bind("keyup",(function(e){self.doProcKeyEvent(1,e)}))},this.freeDesigner=function(){try{null!=canv&&($(canv).unbind("mousemove"),$(canv).unbind("mousedown"),$(canv).unbind("mouseup"))}catch(e){console.error("waiRepDesigner.freeDesigner Unbind Canvas Error : ",e)}try{null!=keyCtrlElem&&($(keyCtrlElem).unbind("keydown"),$(keyCtrlElem).unbind("keyup"))}catch(e){console.error("waiRepDesigner.freeDesigner Unbind KeyCtrl Error : ",e)}},this.doProcKeyEvent=function(e,t){if(t.originalEvent.srcElement===keyCtrlElem){var i=t.keyCode;switch(e){case 0:if(27==i)_InsertMode?(setInsertMode(!1),null!==this.onEndCreateComponent&&this.onEndCreateComponent()):1==dragST&&1==this.selection.moved&&(this.selection.genPosition(),this.selection.moved=!1,this.selection.endDrag(),dragST=!1,this.updateDesign({cmd:"clear"}));else if(8==i);else if(t.ctrlKey)if(t.shiftKey){if(90===i)this.selection.clear(),rpt.doRedo(),this.updateDesign({cmd:"clear"}),t.preventDefault()}else switch(i){case 90:this.selection.clear(),rpt.doUndo(),this.updateDesign({cmd:"clear"}),t.preventDefault(),this.fireOnChangedForm();break;case 37:0==moveKeyDown&&rpt.saveUndo(),moveKeyDown=!0,this.selection.doMoveUnit([-1,0]),this.updateDesign({cmd:"clear"}),t.preventDefault(),this.fireOnChangedForm();break;case 38:0==moveKeyDown&&rpt.saveUndo(),moveKeyDown=!0,this.selection.doMoveUnit([0,-1]),this.updateDesign({cmd:"clear"}),t.preventDefault(),this.fireOnChangedForm();break;case 39:0==moveKeyDown&&rpt.saveUndo(),moveKeyDown=!0,this.selection.doMoveUnit([1,0]),this.updateDesign({cmd:"clear"}),t.preventDefault(),this.fireOnChangedForm();break;case 40:0==moveKeyDown&&rpt.saveUndo(),moveKeyDown=!0,this.selection.doMoveUnit([0,1]),this.updateDesign({cmd:"clear"}),t.preventDefault(),this.fireOnChangedForm();break;case 65:this.allSelect();break;case 67:this.selectControl("copy");break;case 88:this.selectControl("cut");break;case 86:this.selectControl("paste")}else if(t.altKey&&t.shiftKey)switch(i){case 37:0==resizeKeyDown&&rpt.saveUndo(),resizeKeyDown=!0,this.selection.doResizeUnit([-1,0]),this.updateDesign({cmd:"clear"}),t.preventDefault(),this.fireOnChangedForm();break;case 38:0==resizeKeyDown&&rpt.saveUndo(),resizeKeyDown=!0,this.selection.doResizeUnit([0,-1]),this.updateDesign({cmd:"clear"}),t.preventDefault(),this.fireOnChangedForm();break;case 39:0==resizeKeyDown&&rpt.saveUndo(),resizeKeyDown=!0,this.selection.doResizeUnit([1,0]),this.updateDesign({cmd:"clear"}),t.preventDefault(),this.fireOnChangedForm();break;case 40:0==resizeKeyDown&&rpt.saveUndo(),resizeKeyDown=!0,this.selection.doResizeUnit([0,1]),this.updateDesign({cmd:"clear"}),t.preventDefault(),this.fireOnChangedForm()}else if(t.shiftKey)switch(i){case 37:0==resizeKeyDown&&rpt.saveUndo(),resizeKeyDown=!0,this.selection.doResizeUnit([-5,0]),this.updateDesign({cmd:"clear"}),t.preventDefault(),this.fireOnChangedForm();break;case 38:0==resizeKeyDown&&rpt.saveUndo(),resizeKeyDown=!0,this.selection.doResizeUnit([0,-5]),this.updateDesign({cmd:"clear"}),t.preventDefault(),this.fireOnChangedForm();break;case 39:0==resizeKeyDown&&rpt.saveUndo(),resizeKeyDown=!0,this.selection.doResizeUnit([5,0]),this.updateDesign({cmd:"clear"}),t.preventDefault(),this.fireOnChangedForm();break;case 40:0==resizeKeyDown&&rpt.saveUndo(),resizeKeyDown=!0,this.selection.doResizeUnit([0,5]),this.updateDesign({cmd:"clear"}),t.preventDefault(),this.fireOnChangedForm()}else switch(i){case 46:this.selectControl("delete"),t.preventDefault();break;case 37:0==moveKeyDown&&rpt.saveUndo(),moveKeyDown=!0,this.selection.doMoveUnit([-5,0]),this.updateDesign({cmd:"clear"}),t.preventDefault(),this.fireOnChangedForm();break;case 38:0==moveKeyDown&&rpt.saveUndo(),moveKeyDown=!0,this.selection.doMoveUnit([0,-5]),this.updateDesign({cmd:"clear"}),t.preventDefault(),this.fireOnChangedForm();break;case 39:0==moveKeyDown&&rpt.saveUndo(),moveKeyDown=!0,this.selection.doMoveUnit([5,0]),this.updateDesign({cmd:"clear"}),t.preventDefault(),this.fireOnChangedForm();break;case 40:0==moveKeyDown&&rpt.saveUndo(),moveKeyDown=!0,this.selection.doMoveUnit([0,5]),this.updateDesign({cmd:"clear"}),t.preventDefault(),this.fireOnChangedForm()}break;case 1:1==resizeKeyDown&&(resizeKeyDown=!1),1==moveKeyDown&&(moveKeyDown=!1)}}},this.bandSizeChange=function(nm,nv){for(var self=this,names={},n=null,sItems=this.selection.getSelItems(),propNames=null,curItem=null,pInfo=null,pVal="",i=0;i<sItems.length;i++){debug&&console.log("  [",sItems[i].name,"]----------------------");try{curItem="yrBandCtrlClass"==sItems[i].classType?sItems[i].band:sItems[i],propNames=JSON.parse(JSON.stringify(curItem.propertyNames))}catch(e){}if(0==i){for(n in propNames)!0===propNames[n].info.visible&&(pInfo=propNames[n].info,pVal=void 0===pInfo.link?curItem[n]:eval("curItem."+pInfo.link),names[n]={value:pVal,diffe:!1,cate:propNames[n].cate,info:propNames[n].info});debug&&console.log("    - Style Object : ",curItem.style)}else for(n in names)void 0===propNames[n]?delete names[n]:(pInfo=propNames[n].info,pVal=void 0===pInfo.link?curItem[n]:eval("curItem."+pInfo.link),names[n].diffe=names[n].value!==pVal,names[n].value=1==names[n].diffe?"":names[n].value,names[n].info.readonly=1==names[n].info.unique)}if(!(sItems.length<=0)){var band="yrBandCtrlClass"==sItems[0].classType?sItems[0].band:sItems[0].parent;null!==designer&&designer.report.saveUndo(),band.beginUpdate();for(var i=0;i<sItems.length;i++){var curItem="yrBandCtrlClass"==sItems[i].classType?sItems[i].band:sItems[i];if(void 0!==names[nm].info.link){var eTxt="curItem."+names[nm].info.link+" = nv;";eval(eTxt)}else{var value=void 0;value="number"==names[nm].info.type?parseInt((nv+"").trim()):nv,curItem[nm]=value}names[nm].value=curItem[nm]}band.endUpdate(),band.reDraw(),null!==designer&&(designer.updateChild(),designer.updateDesign({cmd:"clear"}),designer.fireOnChangedForm())}},this.disMenu=function(e){var t="#"+e;$(t)[0].style.color="#b2bac0",$(t)[0].disable=!0},this.ableMenu=function(e){var t="#"+e;$(t)[0].style.color="#303030",$(t)[0].disable=!1},this.createMenu=function(e){var t=e.clientX,i=e.clientY,n=$("#img_menu")[0],r=$("#create_menu")[0],s=$("#shadow_menu")[0];n.style.left=t-2+"px",n.style.top=i-2+"px",n.style.display="";var a=n.offsetWidth;r.style.left=n.offsetLeft+a-1+"px",r.style.top=n.offsetTop+"px",r.style.display="",s.style.left=n.offsetLeft+4+"px",s.style.top=n.offsetTop+3+"px",s.style.display="";var o=this.selection.items[0];void 0===o?(this.disMenu("delSelTxt"),this.disMenu("cutTxt"),this.disMenu("copyTxt"),this.disMenu("pasteTxt"),this.disMenu("deleteTxt")):"yrBandCtrlClass"===o.classType?(this.ableMenu("delSelTxt"),this.disMenu("cutTxt"),this.disMenu("copyTxt"),this.disMenu("deleteTxt"),self.clipboard.length>0?this.ableMenu("pasteTxt"):self.clipboard.length<1&&this.disMenu("pasteTxt")):"yrComponentClass"===o.classType&&(this.disMenu("delSelTxt"),this.ableMenu("cutTxt"),this.ableMenu("copyTxt"),this.ableMenu("deleteTxt"),self.clipboard.length>0&&this.ableMenu("pasteTxt"))},this.deleteMenu=function(){$("#shadow_menu")[0].style.display="none",$("#shadow_sub_menu")[0].style.display="none",$("#create_menu")[0].style.display="none",$("#img_menu")[0].style.display="none",$("#insert_sub")[0].style.display="none"},this.etcMenuOver=function(e){$("#shadow_sub_menu")[0].style.display="none",$("#insert_sub")[0].style.display="none",this.etcMenuOut(),1==e?($("#cut_menu")[0].style.border="1px solid #a6ceff",$("#cut_menu")[0].style.borderRadius="5px",$("#cut_menu")[0].style.backgroundColor="#deedff"):2==e?($("#copy_menu")[0].style.border="1px solid #a6ceff",$("#copy_menu")[0].style.borderRadius="5px",$("#copy_menu")[0].style.backgroundColor="#deedff"):3==e?($("#paste_menu")[0].style.border="1px solid #a6ceff",$("#paste_menu")[0].style.borderRadius="5px",$("#paste_menu")[0].style.backgroundColor="#deedff"):4==e?($("#delete_menu")[0].style.border="1px solid #a6ceff",$("#delete_menu")[0].style.borderRadius="5px",$("#delete_menu")[0].style.backgroundColor="#deedff"):5==e&&($("#delSection_menu")[0].style.border="1px solid #a6ceff",$("#delSection_menu")[0].style.borderRadius="5px",$("#delSection_menu")[0].style.backgroundColor="#deedff")},this.etcMenuOut=function(){$("#cut_menu")[0].style.border="1px solid #fafafa",$("#cut_menu")[0].style.backgroundColor="#fafafa",$("#copy_menu")[0].style.border="1px solid #fafafa",$("#copy_menu")[0].style.backgroundColor="#fafafa",$("#paste_menu")[0].style.border="1px solid #fafafa",$("#paste_menu")[0].style.backgroundColor="#fafafa",$("#delete_menu")[0].style.border="1px solid #fafafa",$("#delete_menu")[0].style.backgroundColor="#fafafa",$("#delSection_menu")[0].style.border="1px solid #fafafa",$("#delSection_menu")[0].style.backgroundColor="#fafafa"},this.insertMenuOver=function(e){this.etcMenuOut();var t=$("#create_menu")[0].offsetTop,i=$("#create_menu")[0].offsetLeft,n=$("#insert_menu")[0],r=n.offsetWidth,s=n.offsetTop,a=$("#insert_sub")[0],o=$("#shadow_sub_menu")[0];a.style.top=t+s+"px",a.style.left=i+r+2+"px",a.style.display="",n.style.border="1px solid #a6ceff",n.style.borderRadius="5px",n.style.backgroundColor="#deedff",o.style.top=a.offsetTop+3+"px",o.style.left=a.offsetLeft+3+"px",o.style.display="";for(var h=rpt.formData.layout,l=h.pages[0].bands,c=0;c<l.length;c++){if("pageHeader"===l[c].type){this.disMenu("pageTxt");break}this.ableMenu("pageTxt")}null!==h.reportHeader&&null!==h.reportFooter?this.disMenu("reportTxt"):this.ableMenu("reportTxt")},this.insertMenuOut=function(){$("#insert_menu")[0].style.border="1px solid #fafafa",$("#insert_menu")[0].style.backgroundColor="#fafafa"},this.groupOver=function(){$("#insert_group")[0].style.border="1px solid #a6ceff",$("#insert_group")[0].style.borderRadius="5px",$("#insert_group")[0].style.backgroundColor="#deedff",this.pageOut(),this.insertMenuOut()},this.groupOut=function(){$("#insert_group")[0].style.border="1px solid #fafafa",$("#insert_group")[0].style.backgroundColor="#fafafa"},this.pageOver=function(){$("#insert_page")[0].style.border="1px solid #a6ceff",$("#insert_page")[0].style.borderRadius="5px",$("#insert_page")[0].style.backgroundColor="#deedff",this.groupOut(),this.insertMenuOut()},this.pageOut=function(){$("#insert_page")[0].style.border="1px solid #fafafa",$("#insert_page")[0].style.backgroundColor="#fafafa"},this.reportOver=function(){$("#insert_report")[0].style.border="1px solid #a6ceff",$("#insert_report")[0].style.borderRadius="5px",$("#insert_report")[0].style.backgroundColor="#deedff",this.groupOut(),this.pageOut()},this.reportOut=function(){$("#insert_report")[0].style.border="1px solid #fafafa",$("#insert_report")[0].style.backgroundColor="#fafafa"},this.doMenuProcMouseClickEvent=function(e,t){switch(designer.report.saveUndo(),e){case 0:for(var i=(p=rpt.formData.layout).pages[0].bands,n=0,r=0,s=0,a=0,o=0;o<i.length;o++){if("groupHeader"===i[o].type){var h=i[o].name.split("GroupHeader");s<=(l=parseInt(h[1]))&&(s=l)}if("groupFooter"===i[o].type){var l;h=i[o].name.split("GroupFooter");a<=(l=parseInt(h[1]))&&(a=l)}"detail"===i[o].type&&(n=o,r=o+1)}s+=1,a+=1,p.pages[0].bands.splice(r,0,{name:"GroupFooter"+a,type:"groupFooter",height:200,objects:[],dataSource:null,afterPrint:"",beforePrint:"",vbScript:""}),p.pages[0].bands.splice(n,0,{name:"GroupHeader"+s,type:"groupHeader",height:200,objects:[],dataSource:null,beforePrint:"",afterPrint:"",vbScript:""}),rpt.createReport(),rpt.reDraw(),this.updateDesign({cmd:"clear"}),this.selection.bgCanSize();break;case 1:i=(p=rpt.formData.layout).pages[0].bands;var c=!1;for(o=0;o<i.length;o++)if("pageHeader"===i[o].type){c=!0;break}c||(p.pages[0].bands.unshift({name:"PageHeader",type:"pageHeader",height:200,objects:[],dataSource:null,beforePrint:"",afterPrint:"",vbScript:""}),p.pages[0].bands.push({name:"PageFooter",type:"pageFooter",height:200,objects:[],dataSource:null,afterPrint:"",beforePrint:"",vbScript:""}),rpt.createReport(),rpt.reDraw(),this.updateDesign({cmd:"clear"}),this.selection.bgCanSize());break;case 2:null===(p=rpt.formData.layout).reportHeader&&(p.reportHeader={name:"ReportHeader",type:"reportHeader",height:150,objects:[],dataSource:null,afterPrint:"",beforePrint:"",vbScript:""}),null===p.reportFooter&&(p.reportFooter={name:"ReportFooter",type:"reportFooter",height:150,objects:[],dataSource:null,afterPrint:"",beforePrint:"",vbScript:""}),rpt.createReport(),rpt.reDraw(),this.updateDesign({cmd:"clear"}),this.selection.bgCanSize();break;case 3:var d=this.selection.items[0];if(void 0===d)break;if("yrBandCtrlClass"!==d.classType)break;var p,g=d.band.name,u=d.band.type;for(i=(p=rpt.formData.layout).pages[0].bands,o=0;o<i.length;o++)if(i[o].name==g&&i[o].type==u){if("pageHeader"===u||"pageFooter"===u){i.splice(0,1),i.pop();break}if("groupHeader"===u){var f=i.length-1-o;i[o].name==g&&(i.splice(f,1),i.splice(o,1))}else if("groupFooter"===u){var m=0+(i.length-1)-o;i[o].name==g&&(i.splice(m,1),i.splice(o-1,1))}else"detail"===u&&console.log("Can not delete.")}null!==p.reportHeader&&null!==p.reportFooter&&(p.reportHeader.name===g&&p.reportHeader.type===u||p.reportFooter.name===g&&p.reportFooter.type===u)&&(p.reportHeader=null,p.reportFooter=null),rpt.createReport(),rpt.reDraw(),this.selection.clear(),this.selection.firePropertyChange(),this.updateDesign({cmd:"clear"}),this.selection.bgCanSize();break;case 4:this.selectControl("cut");break;case 5:this.selectControl("copy");break;case 6:this.selectControl("paste");break;case 7:this.selectControl("delete"),t.preventDefault()}this.deleteMenu(),this.selection.clear()},this.doMenuProcMouseEvent=function(e,t){switch(e){case 0:this.etcMenuOver(1);break;case 1:case 3:case 5:case 7:case 17:this.etcMenuOut();break;case 2:this.etcMenuOver(2);break;case 4:this.etcMenuOver(3);break;case 6:this.etcMenuOver(4);break;case 8:this.insertMenuOver(t);break;case 9:this.insertMenuOut();break;case 10:this.groupOver();break;case 11:this.groupOut();break;case 12:this.pageOver();break;case 13:this.pageOut();break;case 14:this.reportOver();break;case 15:this.reportOut();break;case 16:this.etcMenuOver(5)}};var beforeY=0;function setInsertMode(e){if(_InsertMode=e){if(self.selection.items.length>0&&"yrComponentClass"===self.selection.items[0].classType){var t=self.selection.items[0].parent;self.selection.clear(),t.reDraw(),self.updateChild()}self.updateDesign({cmd:"insert"})}else self.updateDesign({cmd:"clear"})}this.doBcanProcMouseEvent=function(e,t){switch(e){case 0:var i=t.offsetX,n=t.offsetY,r=$("#reportCanvasBg")[0],s=$("#designDiv");if(dragST&&"bandSize"==dragType){var a=r.width,o=r.height,h=r.getContext("2d"),l=(this.selection.items[0].top,canv.height,canv.width);if(h.clearRect(0,0,a,o),"s-resize"==canv.style.cursor){var c=t.clientY-beforeY,d=$("#reportCanvas")[0].height;if(r.height>=d?r.height+=c:r.height=d,n>=s[0].offsetHeight/2){var p=5;c<0&&(p=-p),s[0].scrollTop+=p}h.fillStyle="rgba(22,22,22,0.5)",h.fillRect(0,n,l,2),beforeY=t.clientY}this.selection.doDragResize(i,n,canv.style.cursor)}break;case 1:if(dragST&&"bandSize"==dragType){dragST=!1;h=(r=$("#reportCanvasBg")[0]).getContext("2d");r.style.zIndex=-1,this.bandSizeChange("height",this.selection.pos[0].h),this.selection.bgCanSize(),this.selection.endDrag()}}},this.doProcMouseEvent=function(e,t){switch("none"!==$("#create_menu")[0].style.display&&this.deleteMenu(),e){case 0:var i=t.offsetX,n=t.offsetY;if(_InsertMode){if(dragST)this.canvas.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),"line"!==_newCompType?this.updateDesign({cmd:"insert",drawFunc:function(){var e=FXPos.obj,t=FXPos.x,r=FXPos.y,s=i*zoom,a=n*zoom-e.top;if(_gridMode){function o(e,t){var i=t%e;return i>=e/2?t+(e-i):t-i}t=o(_gridTick,t),r=o(_gridTick,r),s=o(_gridTick,s),a=o(_gridTick,a)}_newCompRect.x1=Math.min(t,s),_newCompRect.y1=Math.min(r,a),_newCompRect.x2=Math.max(t,s),_newCompRect.y2=Math.max(r,a),$waiReport.rtl.drawing.canvas=e.design,$waiReport.rtl.drawing.drawSelAreaRect([t,r,s,a],"rgba(0,0,255,0.85)",[])}}):this.updateDesign({cmd:"insert",drawFunc:function(){var e=FXPos.obj,t=FXPos.x,r=FXPos.y,s=i*zoom,a=n*zoom-e.top;if(_gridMode){function o(e,t){var i=t%e;return i>=e/2?t+(e-i):t-i}t=o(_gridTick,t),r=o(_gridTick,r),s=o(_gridTick,s),a=o(_gridTick,a)}_newCompRect.x1=t,_newCompRect.y1=r,_newCompRect.x2=s,_newCompRect.y2=a;var h=e.design.getContext("2d");h.save(),h.strokeStyle="#FF0000",h.setLineDash([]),h.beginPath(),h.moveTo(t,r),h.lineTo(s,a),h.stroke(),h.restore()}})}else if(dragST){if("resize"==dragType)1==this.selection.items.length&&"line"===this.selection.items[0].type?dragLinePt>=0&&this.selection.doDragLine(i,n,dragLinePt,FXPos.x,FXPos.y):this.selection.doDragResize(i,n,canv.style.cursor);else if("selArea"==dragType){this.canvas.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),$waiReport.rtl.drawing.canvas=this.canvas,$waiReport.rtl.drawing.drawSelAreaRect([FXPos.x,FXPos.y,i*zoom,n*zoom])}else this.selection.doDragMove(i,n);if(this.updateDesign({cmd:"drag"}),t.ctrlKey){$("#reportCanvas")[0].getContext("2d");this.selection.drawGuideLinePoint(),this.selection.resetGuideLinePointV(),this.selection.resetGuideLinePointH()}}else{var r=i*zoom,s=n*zoom;dragType=this.changeMouseCursor(r,s)}break;case 1:if(3==t.which){i=t.offsetX,n=t.offsetY;this.selection.clear();var a=rpt.getObjectByXY(i,n);this.selection.new(a),this.createMenu(t);try{keyCtrlElem.focus()}catch(e){}}else if(1==t.which){t.preventDefault();try{keyCtrlElem.focus()}catch(e){}if(0==t.button){var o=t.offsetX,h=t.offsetY;if(_InsertMode)null!==(a=rpt.getObjectByXY(o,h))&&(FXPos.obj=null,"yrComponentClass"===a.classType?FXPos.obj=a.parent:"yrBandCtrlClass"===a.classType?FXPos.obj=a.band:FXPos.obj=a,FXPos.x=o*zoom,FXPos.y=h*zoom-FXPos.obj.top,_newCompRect={x1:FXPos.x,y1:FXPos.y,x2:0,y2:0},dragST=!0);else if("resize"==dragType)dragST=!0,1==this.selection.items.length&&"line"===this.selection.items[0].type?(0==dragLinePt?(FXPos.x=this.selection.items[0].x1,FXPos.y=this.selection.items[0].y1):1==dragLinePt&&(FXPos.x=this.selection.items[0].x2,FXPos.y=this.selection.items[0].y2),this.selection.moved=!0):(dragLinePt=-1,this.selection.genPosition(),this.selection.startDrag(o,h));else if("bandSize"==dragType){dragST=!0,dragLinePt=-1;var l=$("#reportCanvasBg")[0];l.getContext("2d");l.style.zIndex=99999,this.selection.genPosition(),this.selection.startDrag(o,h)}else{if(null!==(a=rpt.getObjectByXY(o,h))){if(this.selection.hasObject(a)){i=t.offsetX,n=t.offsetY;"yrComponentClass"===a.classType&&(dragST=!0,this.selection.genPosition(),this.selection.startDrag(i,n))}else t.shiftKey?this.selection.add(a):t.ctrlKey?(dragST=!0,dragType="selArea",FXPos.obj=a,FXPos.x=o*zoom,FXPos.y=h*zoom,this.setShowDesignCanvas(!0)):this.selection.new(a);this.updateChild(null)}else console.log("   > is null")}}}break;case 2:r=t.offsetX*zoom,s=t.offsetY*zoom;if(_InsertMode)setInsertMode(!1),dragST=!1,0==t.button&&this.createNewComponent(FXPos.obj,_newCompType,_newCompRect);else if(this.changeMouseCursor(r,s),0==t.button)if(dragST&&"selArea"==dragType)this.selectAreaRect(r,s),this.setShowDesignCanvas(!1),dragST=!1,this.updateChild(null);else{if(dragST)if(this.selection.endDrag(),this.selection.moved);else null!==(a=rpt.getObjectByXY(t.offsetX,t.offsetY))&&(t.shiftKey?this.selection.add(a):this.selection.new(a),this.updateChild(null));this.updateDesign({cmd:"clear"}),dragST=!1}}rpt.doProcMouseEvent(e,t)},this.selectControlBatch=function(e){if(this.selection.items.length<1)return!1;var t=this.selection.items[0].parent;t.beginUpdate(),rpt.saveUndo();for(var i=0;i<e.length;i++)this.selectControl(e[i],!0);t.endUpdate(),t.reDraw(),this.updateChild()},this.clipboard=[],this.addComponent=function(e,t){var i=t.objects,n=e.left,r=e.top,s=e.width,a=e.height,o=n,h=r;!function e(){for(var t=0;t<i.length;t++){var o=i[t].left,h=i[t].top,l=i[t].width,c=i[t].height;o==n&&h==r&&l==s&&c==a&&(n+=10,r+=10,e())}}(),e.left=n,e.top=r;var l=JSON.parse(JSON.stringify(e)),c=(l.name+"").trim();(debug&&console.log("reportDesigner.addComponent : ",l," / ",t),""!==c)?null!==rpt.findDataByName(c)&&(c=rpt.newNameOfType(l.type)):c=rpt.newNameOfType(l.type);l.name=c;var d="line"!==l.type?l.top+l.height:l.y2;t.height<d&&(t.height=d);var p=t.addComponent(l);return null!==p?(this.selection.add(p),this.fireOnChangedForm(),e.left=o,e.top=h,p):null},this.newComponentOnDesign=function(e){if(null===$waiReport.core.getComponentBase(e)){var t='reportDesigner.newComponentOnDesign : Component type "'+e+'" not founded.',i=new Error(t);throw debug&&console.error(t),i}_newCompType=e,setInsertMode(!0)},this.onEndCreateComponent=null,this.createNewComponent=function(e,t,i){var n=null;"line"!==t?(n={type:t,name:rpt.newNameOfType(t),left:i.x1,top:i.y1,width:i.x2-i.x1,height:i.y2-i.y1},"label"==t?(n.caption=n.name,n.width=n.width<=0?10*_gridTick:n.width,n.height=n.height<=0?4*_gridTick:n.height):"textbox"==t?(n.text=n.name,n.width=n.width<=0?10*_gridTick:n.width,n.height=n.height<=0?4*_gridTick:n.height):(n.width=n.width<=0?5*_gridTick:n.width,n.height=n.height<=0?5*_gridTick:n.height)):n={type:t,name:rpt.newNameOfType(t),x1:i.x1,y1:i.y1,x2:i.x2,y2:i.y2},null!==n&&(debug&&console.log("reportDesigner.createNewComponent",t,i,n),this.addComponent(n,e),e.reDraw(),this.updateChild(),this.updateDesign({cmd:"clear"}),null!==this.onEndCreateComponent&&this.onEndCreateComponent())},this.selectControl=function(e,t){if(this.selection.items.length<1)return!1;var i=["copy","cut","paste","delete","alignLeft","alignRight","alignTop","alignBottom","alignEqualVert","alignEqualHorz","sizeMaxHeight","sizeMaxWidth","sizeMinHeight","sizeMinWidth","equalHeight","equalWidth"],n=-1;for(l=0;l<i.length;l++)if((e+"").toUpperCase()==i[l].toUpperCase()){n=l;break}if(n<0)return console.error('[reportDesigner] Unknown "selectControl" command : ['+e+"]"),!1;var r=this.selection.items,s=null;if("yrComponentClass"==r[0].classType&&(s=r[0].parent),n>=0&&n<=3){function a(){self.clipboard=[];for(var e=0;e<r.length;e++)self.clipboard.push(JSON.parse(JSON.stringify(r[e].info)))}function o(){var e,t,i;for(e=r.length-1;e>=0;e--)for(t=s.objects.length-1;t>=0;t--)if(r[e]===s.objects[t]){for(r.splice(e,1),i=s.info.objects.length-1;i>=0;i--)if(s.info.objects[i]===s.objects[t].info){s.info.objects.splice(i,1);break}s.objects[t]=void 0,s.objects.splice(t,1),s.regenNamedObject();break}}switch(null!==s&&s.info,n){case 0:null!==s&&a();break;case 1:null!==s&&(rpt.saveUndo(),a(),o(),this.selection.clear(),this.selection.add(s.ctrl),s.reDraw(),this.updateChild(),this.fireOnChangedForm());break;case 2:rpt.saveUndo();var h=null!==s?s:"yrBandCtrlClass"==r[0].classType?r[0].band:r[0];this.selection.clear();for(var l=0;l<this.clipboard.length;l++)this.addComponent(this.clipboard[l],h);null!==h&&(h.reDraw(),this.updateChild(),this.fireOnChangedForm()),this.updateDesign({cmd:"clear"});break;case 3:null!==s&&(rpt.saveUndo(),o(),this.selection.clear(),this.selection.add(s.ctrl),s.reDraw(),this.updateChild(),this.fireOnChangedForm())}}else if(n>=4&&n<=15){if(null==s)return!1;if(this.selection.items.length<=1)return!1;switch(!0!==t&&(s.beginUpdate(),rpt.saveUndo()),n){case 4:var c=99999,d=0;for(l=0;l<r.length;l++)c=c>(d="line"!==r[l].type?r[l].left:r[l].x1)?d:c;for(l=0;l<r.length;l++)if("line"!==r[l].type)r[l].left=c;else{var p=Math.min(r[l].x1,r[l].x2),g=Math.max(r[l].x1,r[l].x2);r[l].x2=g+(c-p),r[l].x1=c}break;case 5:var u=-1;d=0;for(l=0;l<r.length;l++)u=u<(d="line"!==r[l].type?r[l].left+r[l].width:r[l].x2)?d:u;for(l=0;l<r.length;l++)if("line"!==r[l].type)r[l].left=u-r[l].width;else{p=Math.min(r[l].x1,r[l].x2),g=Math.max(r[l].x1,r[l].x2);r[l].x1=u-(g-p),r[l].x2=u}break;case 6:var f=99999,m=0;for(l=0;l<r.length;l++)f=f>(m="line"!==r[l].type?r[l].top:r[l].y1)?m:f;for(l=0;l<r.length;l++)if("line"!==r[l].type)r[l].top=f;else{var v=Math.min(r[l].y1,r[l].y2),y=Math.max(r[l].y1,r[l].y2);r[l].y2=y+(f-v),r[l].y1=f}break;case 7:var b=-1;m=0;for(l=0;l<r.length;l++)b=b<(m="line"!==r[l].type?r[l].top+r[l].height:r[l].y2)?m:b;for(l=0;l<r.length;l++)if("line"!==r[l].type)r[l].top=b-r[l].height;else{v=Math.min(r[l].y1,r[l].y2),y=Math.max(r[l].y1,r[l].y2);r[l].y1=b-(y-v),r[l].y2=b}break;case 8:if(r.length>2){var w=[];for(l=0;l<r.length;l++)w.push(r[l]);w.sort((function(e,t){var i="line"!==e.type?e.top:e.y1,n="line"!==t.type?t.top:t.y1;return i<n?-1:i>n?1:0}));var x=w.length-1,C="line"!==w[0].type?w[0].top:Math.min(w[0].y1,w[0].y2),P=(R="line"!==w[x].type?w[x].top+w[x].height:Math.max(w[x].y1,w[x].y2))-C;for(l=0;l<w.length;l++){P-=M=(M="line"!==w[l].type?w[l].height:w[l].y2-w[l].y1)<0?-1*M:M}P=Math.floor(P/(w.length-1));var S=C;for(l=0;l<w.length-1;l++){if("line"!==w[l].type)w[l].top=S,S+=w[l].height;else{v=Math.min(w[l].y1,w[l].y2),y=Math.max(w[l].y1,w[l].y2);w[l].y2=y+(S-v),w[l].y1=S,S+=y-v}S+=P}}break;case 9:if(r.length>2){w=[];for(l=0;l<r.length;l++)w.push(r[l]);w.sort((function(e,t){var i="line"!==e.type?e.left:e.x1,n="line"!==t.type?t.left:t.x1;return i<n?-1:i>n?1:0}));x=w.length-1;var D="line"!==w[0].type?w[0].left:Math.min(w[0].x1,w[0].x2),O=($="line"!==w[x].type?w[x].left+w[x].width:Math.max(w[x].x1,w[x].x2))-D;for(l=0;l<w.length;l++){var M;O-=M=(M="line"!==w[l].type?w[l].width:w[l].x2-w[l].x1)<0?-1*M:M}O=Math.floor(O/(w.length-1));var j=D;for(l=0;l<w.length-1;l++){if("line"!==w[l].type)w[l].left=j,j+=w[l].width;else{p=Math.min(w[l].x1,w[l].x2),g=Math.max(w[l].x1,w[l].x2);w[l].x2=g+(j-p),w[l].x1=j,j+=g-p}j+=O}}}switch(n){case 10:b=-1,m=0;for(l=0;l<r.length;l++)b=b<(m=(m="line"!==r[l].type?r[l].height:r[l].y2-r[l].y1)<0?-1*m:m)?m:b;for(l=0;l<r.length;l++)if("line"!==r[l].type)r[l].height=b;else{v=Math.min(r[l].y1,r[l].y2);r[l].y1=v,r[l].y2=v+b}break;case 11:var I=-1;m=0;for(l=0;l<r.length;l++)I=I<(m=(m="line"!==r[l].type?r[l].width:r[l].x2-r[l].x1)<0?-1*m:m)?m:I;for(l=0;l<r.length;l++)if("line"!==r[l].type)r[l].width=I;else{p=Math.min(r[l].x1,r[l].x2);r[l].x1=p,r[l].x2=p+I}break;case 12:f=99999,m=0;for(l=0;l<r.length;l++)f=f>(m=(m="line"!==r[l].type?r[l].height:r[l].y2-r[l].y1)<0?-1*m:m)?m:f;for(l=0;l<r.length;l++)if("line"!==r[l].type)r[l].height=f;else{v=Math.min(r[l].y1,r[l].y2);r[l].y1=v,r[l].y2=v+f}break;case 13:var T=99999;m=0;for(l=0;l<r.length;l++)T=T>(m=(m="line"!==r[l].type?r[l].width:r[l].x2-r[l].x1)<0?-1*m:m)?m:T;for(l=0;l<r.length;l++)if("line"!==r[l].type)r[l].width=T;else{p=Math.min(r[l].x1,r[l].x2);r[l].x1=p,r[l].x2=p+T}break;case 14:if(r.length>2){w=[];for(l=0;l<r.length;l++)w.push(r[l]);w.sort((function(e,t){var i="line"!==e.type?e.top:e.y1,n="line"!==t.type?t.top:t.y1;return i<n?-1:i>n?1:0}));x=w.length-1,C="line"!==w[0].type?w[0].top:Math.min(w[0].y1,w[0].y2);var R="line"!==w[x].type?w[x].top+w[x].height:Math.max(w[x].y1,w[x].y2),_=Math.round((R-C)/w.length),k=0;S=C;for(l=0;l<w.length;l++){if(k=l<w.length-1?_:R-S,"line"!==w[l].type)w[l].top=S,w[l].height=k;else{v=Math.min(w[l].y1,w[l].y2),y=Math.max(w[l].y1,w[l].y2);w[l].y1=S,w[l].y2=S+k}S+=k}}break;case 15:if(r.length>2){w=[];for(l=0;l<r.length;l++)w.push(r[l]);w.sort((function(e,t){var i="line"!==e.type?e.left:e.x1,n="line"!==t.type?t.left:t.x1;return i<n?-1:i>n?1:0}));x=w.length-1,D="line"!==w[0].type?w[0].left:Math.min(w[0].x1,w[0].x2);var $="line"!==w[x].type?w[x].left+w[x].width:Math.max(w[x].x1,w[x].x2),F=Math.round(($-D)/w.length),N=0;j=D;for(l=0;l<w.length;l++)N=l<w.length-1?F:$-j,"line"!==w[l].type?(w[l].left=j,w[l].width=N):(w[l].x1=j,w[l].x2=j+N),j+=N}}!0!==t&&(s.endUpdate(),s.reDraw(),this.updateChild()),this.fireOnChangedForm()}},Object.defineProperty(this,"showOutline",{get:function(){return showCompOL},set:function(e){showCompOL!=e&&(showCompOL=e,rpt.showOutline=showCompOL,this.updateChild(null),_InsertMode&&self.updateDesign({cmd:"insert"}))}}),Object.defineProperty(this,"report",{get:function(){return rpt}}),Object.defineProperty(this,"zoomOut",{get:function(){return zoom},set:function(e){zoom=e,self.selection.zoom=e,rpt.zoomOut=zoom,this.selection.bgCanSize()}}),Object.defineProperty(this,"formData",{get:function(){return rpt.formData}}),Object.defineProperty(this,"onSelectionChange",{get:function(){return _onSelectionChange},set:function(e){_onSelectionChange=e}}),Object.defineProperty(this,"gridMode",{get:function(){return _gridMode},set:function(e){_gridMode=e,rpt.gridMode=e,self.selection.gridMode=e,_InsertMode&&self.updateDesign({cmd:"insert"})}}),Object.defineProperty(this,"gridTick",{get:function(){return _gridTick},set:function(e){_gridTick=e,rpt.gridTick=e,self.selection.gridTick=e}}),Object.defineProperty(this,"insertMode",{get:function(){return _InsertMode},set:function(e){setInsertMode(e)}}),this.init(callback)};$waiReport.classes.reportDesigner=_yrReportDesigner;var _yrViewPage=function(e,t){this.canvas=document.createElement(e,t),this.canvas.width=e,this.canvas.height=t},_yrReportViewer=function(){var self=this,rpt=null,_paperType="",_paperWidth=2166,_paperHeight=3063,_paperOrient=0,bufCanvas=null,bufMax=5,ready=!1,_pageIndex=-1;this.Pages=[];var printPage=[],defScriptObject={OnFormat:null,OnBeforePrint:null,OnAfterPrint:null},defReportScriptObject={OnReportStart:null,OnReportEnd:null,OnPageStart:null,OnPageEnd:null,OnDataInitialize:null,OnFetchData:null,OnNoData:null};this.scripts={report:{},pages:[],bands:{}};{function Len(e){return(e+"").length}function len(e){return Len(e)}function LEN(e){return Len(e)}function Mid(e,t,i){return void 0===i?(e+"").substr(t):(e+"").substr(t,i)}function mid(e,t,i){return Mid(e,t,i)}function MID(e,t,i){return Mid(e,t,i)}}function setBufferCanvas(){null===bufCanvas&&(bufCanvas=document.createElement("canvas")),bufCanvas.width=_paperWidth,bufCanvas.height=_paperHeight*bufMax}function dt2str(e){return""+e.getFullYear()+e.getMonth()+e.getDay()+e.getHours()+e.getHours()+e.getMinutes()+e.getSeconds()+e.getMilliseconds()}function groupingData(e,t){var i={grouped:!1,grpKeys:[],groups:[],recs:[],keyField:e};if(t.length>0)if(void 0!==t[0][e]){i.grouped=!0;var n,r=void 0;for(n=0;n<t.length;n++)r!==t[n][e]&&(r=t[n][e],void 0===i.groups[r]&&(i.grpKeys.push(r),i.groups[r]={first:JSON.parse(JSON.stringify(t[n])),recs:[],last:JSON.parse(JSON.stringify(t[t.length-1]))})),i.groups[r].recs.push(JSON.parse(JSON.stringify(t[n])))}else i.recs=JSON.parse(JSON.stringify(t));return i}function genSummaryFields(e){var t,i,n=[];for(t=0;t<e.length;t++){var r=e[t],s=r.info.objects,a=null;for(i=0;i<s.length;i++){var o={distinct:void 0!==(a=s[i]).summaryDistinct?a.summaryDistinct:"",func:void 0!==a.summaryFunc?a.summaryFunc:"0",group:void 0!==a.summaryGroup?a.summaryGroup:"",running:void 0!==a.summaryRunning?a.summaryRunning:"0",type:void 0!==a.summaryType?a.summaryType:"0",fromBand:void 0,fromObj:void 0,class:void 0};if("0"!==o.type){var h=$waiReport.const.summaryFuncs[o.func];void 0!==h&&(o.class=new h.func,o.fromBand=r,o.fromObj=a,n.push(o))}}}return n}function execGroupGrandSum(e,t,i){var n,r,s,a,o={},h=[],l=self.summaries;for(n=0;n<l.length;n++)"1"==(s=l[n]).type&&h.push(s);if(i.length>0)for(n=0;n<h.length;n++){var c=""!==((a=h[n]).fromObj.name+"").trim()?(a.fromObj.name+"").trim():null,d=""!==(a.fromObj.dataField+"").trim()?(a.fromObj.dataField+"").trim():null;if(null!=c&&null!=d&&void 0!==i[0][d]){for(r=0;r<i.length;r++)a.class.exec(i[r][d]);o[c+"_"+d]=a.class.getValue()}}return o}function execGroupSummary(e,t,i){var n,r,s,a,o={},h=[],l=self.summaries;for(n=0;n<l.length;n++)"1"==(s=l[n]).running&&(s.group!=t.name&&e.footer!==s.fromBand||h.push(s));for(n=0;n<h.length;n++)"3"==(a=h[n]).type&&a.class.clear();if(i.length>0)for(n=0;n<h.length;n++)if("2"===(a=h[n]).func){for(r=0;r<i.length;r++)a.class.exec(i[r]);try{a.fromObj.text=a.class.getValue()}catch(e){}}else{var c=a.distinct;if(void 0!==i[0][c]){for(r=0;r<i.length;r++)a.class.exec(i[r][c]);o[c]=a.class.getValue()}}return o}function buildPrintProc(e){var t,i,n={header:null,child:null,footer:null},r=[];for(t=0;t<e.length;t++)"pageHeader"!=(i=e[t]).type&&"pageFooter"!=i.type&&r.push(i);if(1==r.length)n.child=r[0];else{t=0,function e(i){"groupHeader"==r[t].type?(i.header=r[t],i.child={header:null,child:null,footer:null},t++,e(i.child),t++,i.footer=r[t]):i.child=r[t]}(n)}return n}function printBand(e,t,i,n,r,s){var a=t;return e.setCompValues(a),self.exeBandScript(i[e.name],"OnFormat"),self.exeBandScript(i[e.name],"OnBeforePrint"),e.height>0&&(e.canGrow&&self.canGrowResize(e),e.draw(t),n.drawImage(e.canvas,0,r)),self.exeBandScript(i[e.name],"OnAfterPrint"),r+=e.height}this.init=function(){setBufferCanvas(),(rpt=new $waiReport.classes.report(this,$waiReport.const.newDefaultData())).showOutline=!1},this.generateScript=function(){this.scripts={report:{},pages:[],bands:{}};var RD=rpt.formData;function createScript(dObj,sObj){var rt={};for(x in sObj)try{var sct=dObj.script[x];if(void 0!==sct&&""!==(sct+"").trim()){var nm=void 0!==dObj.name?"["+dObj.name+"].":"",evTxt='rt[x] = function(){\nif (debug) console.log("  - scriptExec : '+nm+x+'");\n'+sct+"\n};";eval(evTxt)}else rt[x]=null}catch(e){console.log("waiReport.createScript Error ["+x+"] : "+e.message,e)}return rt}function NotUN(e){return null!=e}NotUN(RD.script)&&(this.scripts.report=createScript(RD,defReportScriptObject)),NotUN(RD.layout.reportHeader)&&NotUN(RD.layout.reportHeader.script)&&(this.scripts.bands[RD.layout.reportHeader.name]=createScript(RD.layout.reportHeader,defScriptObject)),NotUN(RD.layout.reportFooter)&&NotUN(RD.layout.reportFooter.script)&&(this.scripts.bands[RD.layout.reportFooter.name]=createScript(RD.layout.reportFooter,defScriptObject));for(var i=0;i<RD.layout.pages.length;i++){for(var pageSct={bands:{}},page=RD.layout.pages[i],band=null,j=0;j<page.bands.length;j++)band=page.bands[j],NotUN(band.script)&&(pageSct.bands[band.name]=createScript(band,defScriptObject));this.scripts.pages.push(pageSct)}},this.exeScript=function(e,t){try{null!=e&&(rpt.setUpdateSections(!0),e(),rpt.setUpdateSections(!1))}catch(e){throw console.error("["+t+"] Error : ",e),e}},this.exeBandScript=function(e,t){if(null==e)return!1;var i=e[t];try{this.exeScript(i,e.name+"."+t)}catch(e){console.log("exeBandScript Error : ["+t+"]\n"+e.message,e)}return!0},this.propertyChange=function(e,t,i,n){var r=null,s=rpt.Sections(e),a=null;if(null!==s)if(void 0!==(a=s.Controls(t)))if(void 0!==a.propertyNames[i])a[i]=n;else{var o=(i+"").trim().toUpperCase();for(var h in i="",a.propertyNames){if((h+"").toUpperCase()===o){i=h;break}}""!==i&&(a[i]=n)}else r=new Error('reportViewer : Control "'+t+'" not founded in Section "'+e+'"');else r=new Error('reportViewer : Section "'+e+'" not founded.');if(null!==r&&raiseThrow)throw r;return void 0===a?null:a},this.updateChild=function(e){},this.updateCanvas=function(e){},this.loadedFormUrl="",this.loadForm=function(e){ready=!1;var t=dt2str(new Date),i="POST";try{i=$waiReport.const.AjaxCallType.FormFileLoad}catch(e){}var n=!1,r={type:i,url:e+"?nocache="+t,dataType:"json",async:!1,timeout:5e3,data:"",error:function(t,i,n){alert("[waiReport] report form(yrf) load error\n\nURL : "+e+"\nError : "+n)},success:function(t,i,r){self.loadedFormUrl=e,rpt.formData=t,rpt.createReport(),rpt.draw(),ready=!0,_paperType=t.pageSetting.paper.type,_paperWidth=t.pageSetting.paper.width,_paperHeight=t.pageSetting.paper.height,_paperOrient=t.pageSetting.orientation,setBufferCanvas(),debug&&(console.log('[ reportViewer.loadForm ] : "'+e+'"'),console.log("   - PagerType   :",_paperType),console.log("   - PaperWidth  :",_paperWidth),console.log("   - PaperHeight :",_paperHeight),console.log("   - PaperOrient :",_paperOrient)),n=!0}};return $.ajax(r),n},this.summaries=[],this.generateSummary=function(){var e=[];null!==rpt.header&&e.push(rpt.header);for(var t=0;t<rpt.pages.length;t++)for(var i=rpt.pages[t].children,n=0;n<i.length;n++)e.push(i[n]);null!==rpt.footer&&e.push(rpt.footer);for(var r=0;r<this.summaries.length;r++){var s=this.summaries[r];s.fromBand=void 0,s.fromObj=void 0,s.class=void 0}this.summaries=[],this.summaries=genSummaryFields(e)},this.canGrowResize=function(e){for(var t=0,i=0;i<e.children.length;i++){var n=0;try{n=parseInt(e.children[i].top+e.children[i].height)}catch(e){n="NaN"}n+""!="NaN"&&(t=Math.max(t,n))}if(t>e.height){var r=e.ratio;e.ratio=1,e.height=t,e.ratio=r}},this.delayBandDraw=function(e,t,i){window.setTimeout((function(){e.drawImage(t,0,i)}),50)};var pInfo={pages:[],count:0,curIdx:0,curTop:0},sysValues={detailTotal:0,detailIndex:0,detailIndexOfGroup:0,detailIndexOfPage:0,groupTotal:{},groupIndex:{},groupIndexOfPage:{}},prevPages=[],prevPagesHorz=[];function vtoi(e){var t=0;return null!==e&&(t=e),t}function rotateAndPaintImage(e,t,i,n,r,s,a){e.translate(n,r),e.rotate(i),e.drawImage(t,-s,-a),e.rotate(-i),e.translate(-n,-r)}this.drawPrevPage=function(e,t){var i=pInfo.pages[e],n=(rpt.formData.pageSetting.margin,vtoi(rpt.formData.pageSetting.margin.top)),r=(vtoi(rpt.formData.pageSetting.margin.bottom),vtoi(rpt.formData.pageSetting.margin.left)),s=vtoi(rpt.formData.pageSetting.margin.right);t.width=genWidth,t.height=genHeight;var a=t.width-(r+s),o=t.height,h=a/genWidth,l=o/genHeight,c=Math.min(h,l);t.getContext("2d").drawImage(i,0,0,i.width,i.height,r,n,i.width*c,i.height*c)},this.drawCurrentPrevPage=function(e,t,i){var n,r,s=rpt.formData.pageSetting,a=genPrevInfo.curCanvas,o=vtoi(rpt.formData.pageSetting.margin.top),h=vtoi(rpt.formData.pageSetting.margin.bottom),l=vtoi(rpt.formData.pageSetting.margin.left),c=(vtoi(rpt.formData.pageSetting.margin.right),genWidth>genHeight),d=(s.paper.type+"").toUpperCase(),p=$waiReport.const.paperPixel[d].horz,g=$waiReport.const.paperPixel[d].vert;(c?(e.width=Math.floor(g*i),e.height=Math.floor(p*i),r=(n=document.createElement("canvas")).getContext("2d"),n.width=genHeight,n.height=genWidth,rotateAndPaintImage(r,a,Math.PI/180*90,0,0,0,a.height),t.width=Math.floor(p*i),t.height=Math.floor(g*i)):(e.width=Math.floor(p*i),e.height=Math.floor(g*i),t.width=0,t.height=0),e.getContext("2d").drawImage(a,0,0,a.width,a.height,l*i,o*i,a.width*i,a.height*i),c)&&(t.getContext("2d").drawImage(n,0,0,n.width,n.height,h*i,l*i,n.width*i,n.height*i),r=void 0,n.width=0,n.height=0,n=void 0)},this.convPrevPages=function(e){if(prevPages=[],prevPagesHorz=[],0!=e.length){rpt.formData.pageSetting.margin;for(var t=vtoi(rpt.formData.pageSetting.margin.top),i=(vtoi(rpt.formData.pageSetting.margin.bottom),vtoi(rpt.formData.pageSetting.margin.left)),n=vtoi(rpt.formData.pageSetting.margin.right),r=0;r<e.length;r++){var s=document.createElement("canvas");s.width=genWidth,s.height=genHeight;var a=s.width-(i+n),o=s.height,h=a/genWidth,l=o/genHeight,c=Math.min(h,l),d=s.getContext("2d");if(d.drawImage(e[r],0,0,e[r].width,e[r].height,i,t,e[r].width*c,e[r].height*c),s.width>s.height){var p=document.createElement("canvas"),g=p.getContext("2d");p.width=s.height,p.height=s.width,rotateAndPaintImage(g,s,Math.PI/180*90,0,0,0,s.height),(u=document.createElement("img")).style.width="816px",u.style.height="1056px",u.src=s.toDataURL(),prevPages.push(u),prevPagesHorz.push(u),g=void 0,p=void 0}else{var u;(u=document.createElement("img")).style.width="816px",u.style.height="1056px",u.src=s.toDataURL(),prevPages.push(u),prevPagesHorz.push(null)}d=void 0,s=void 0}this.clearPrint()}},this.clearPrint=function(){for(var e=0;e<pInfo.pages.length;e++)pInfo.pages[e].width=0,pInfo.pages[e].height=0,pInfo.pages[e]=null,pInfo.pages[e]=void 0;pInfo.pages=[],pInfo.count=0,pInfo.curIdx=0,pInfo.curTop=0};var genWidth=0,genHeight=0,ratio=1,genPrevInfo={curCanvas:null,curPageIdx:-1,pageTotal:0,curTop:0};function setSysValues(band){band.beginUpdate();for(var i=0;i<band.objects.length;i++){var o=band.objects[i];if("textbox"==o.type){var sysVal=void 0!==o.dataField?(o.dataField+"").replace(/ /g,""):"";if(sysVal.toUpperCase().indexOf("=SYSVALUE(")>=0){var sysValItem=sysVal.substr(10,sysVal.length-11),v=null;try{eval("v = sysValues."+sysValItem+";")}catch(e){v=null}null!==v&&(o.text=v+"")}}}band.endUpdate()}this.clearPrevBuffer=function(){null!==genPrevInfo.curCanvas&&(genPrevInfo.curCanvas.width=0,genPrevInfo.curCanvas.height=0,genPrevInfo.curCanvas=void 0),genPrevInfo.curCanvas=null,genPrevInfo.curPageIdx=-1,genPrevInfo.pageTotal=0,genPrevInfo.curTop=0},this.preventLoadImages=function(e){var t=rpt.pageCount>0?rpt.pages[0]:null;if(null!==t){var i=0;rpt.prevLoadedImages=[];var n=[];o(rpt.header);for(var r=0;r<t.bands.length;r++)o(t.bands[r]);if(o(rpt.footer),0==n.length)e();else{i=n.length;for(var s=0;s<n.length;s++){var a={name:n[s].name,img:null};a.img=new Image,a.img.onload=function(){--i<=0&&e()},a.img.src=n[s].data,rpt.prevLoadedImages.push(a)}}}function o(e){if(null!=e)for(var t=0;t<e.objects.length;t++){var i=e.objects[t];if("image"===i.type){if(console.log("    [image] : "+i.name),void 0===i.data||i.data.length<=0)continue;n.push(i)}}}},this.generatePreview=function(e,t,i,n,r){var s=rpt.formData.pageSetting;genWidth=s.paper.width;var a=$waiReport.const.paperRatios,o=(s.paper.type+"").toUpperCase(),h=1===_paperOrient?"horz":"vert",l=a[o];void 0===l&&(console.warn('[waiReport] paper type "'+o+'" undefined as "waiRepConst" setted "A4" paper'),o="A4"),l=a[o][h],genHeight=Math.floor(s.paper.width*l);var c=vtoi(s.margin.top),d=vtoi(s.margin.bottom),p=vtoi(s.margin.left),g=vtoi(s.margin.right),u=s.paper.width,f=s.paper.height,m=$waiReport.const.paperPixel[o];genWidth=(0==_paperOrient?m.horz:m.vert)-(p+g),genHeight=(0==_paperOrient?m.vert:m.horz)-(c+d),ratio=genWidth/s.paper.width;var v=JSON.parse(JSON.stringify(rpt.formData));console.log('[waiReport] Generate "preview" paper info "'+self.loadedFormUrl+'"\n\nform-width  : '+u+"px\nform-height : "+f+"px\n\nPaper type   : "+o+"\nPaper orient : "+h+"\nPaper vertical Ratio : "+l+"\n\nPaper Width  : "+genWidth+" px\nPaper Height : "+genHeight+" px\nResize Ratio : "+ratio+"\nMax Band Height : "+Math.floor(genHeight/ratio)),this.clearPrevBuffer(),this.generateScript(),this.generateSummary();for(var y=0;y<rpt.pages.length;y++){rpt.loadFormData(JSON.parse(JSON.stringify(v))),this.generatePreviewPage(y,e,t,!1,void 0,i,n,r);var b={pageCount:genPrevInfo.pageTotal};null!==i&&i(genPrevInfo),this.clearPrevBuffer(),rpt.loadFormData(JSON.parse(JSON.stringify(v))),this.generatePreviewPage(y,e,t,!0,b,i,n,r)}return!0},this.generatePreviewPage=function(e,t,i,n,r,s,a,o){var h=null,l=void 0===n||n,c=rpt.pages[e].children,d=this.scripts,p=(vtoi(rpt.formData.pageSetting.margin.top),vtoi(rpt.formData.pageSetting.margin.bottom),genHeight);function g(e,t){for(var i=printPage.length-1,n=JSON.parse(JSON.stringify(e.info)),r=0;r<n.objects.length;r++)if("subReport"==n.objects[r].type){var s=n.objects[r];if(s.reportName.indexOf("yrf")>0){var a=new _yrReportViewer;if(!a.loadForm(s.reportName))break;function o(){}s.type="subReportSuccess";var h=null==t[s.dataField]?new Array:t[s.dataField];a.generateSubRepPreview(h,null,o,o,!1,ratio);for(var l=0,c=0;c<a.printPages[0].bands.length&&!(l>s.height);c++){for(var d=0;d<a.printPages[0].bands[c].objects.length;d++){if("line"==a.printPages[0].bands[c].objects[d].type){var p=a.printPages[0].bands[c].objects[d].x1,g=a.printPages[0].bands[c].objects[d].x2,u=a.printPages[0].bands[c].objects[d].y1,f=a.printPages[0].bands[c].objects[d].y2;if(p>s.width||g>s.width||u+l>s.height||f+l>s.height)continue;a.printPages[0].bands[c].objects[d].x1+=s.left,a.printPages[0].bands[c].objects[d].x2+=s.left,a.printPages[0].bands[c].objects[d].y1+=s.top+l,a.printPages[0].bands[c].objects[d].y2+=s.top+l}else{var m=a.printPages[0].bands[c].objects[d].top,v=a.printPages[0].bands[c].objects[d].left,y=a.printPages[0].bands[c].objects[d].width,b=a.printPages[0].bands[c].objects[d].height;if(v+y>s.width||m+b+l>s.height)continue;a.printPages[0].bands[c].objects[d].top+=s.top+l,a.printPages[0].bands[c].objects[d].left+=s.left}n.objects.push(a.printPages[0].bands[c].objects[d])}l+=a.printPages[0].bands[c].height}}}printPage[i].bands.push(n)}!function(){function e(e){for(var t in e.beginUpdate(),e.canvas.width=genWidth,e.height=e.height*ratio,e.ratio=ratio,e.objects)"line"==e.objects[t].type?(e.objects[t].x1=Number((e.objects[t].x1*ratio).toFixed(2)),e.objects[t].x2=Number((e.objects[t].x2*ratio).toFixed(2)),e.objects[t].y1=Number((e.objects[t].y1*ratio).toFixed(2)),e.objects[t].y2=Number((e.objects[t].y2*ratio).toFixed(2))):(e.objects[t].left=Number((e.objects[t].left*ratio).toFixed(2)),e.objects[t].top=Number((e.objects[t].top*ratio).toFixed(2)),e.objects[t].width=Number((e.objects[t].width*ratio).toFixed(2)),e.objects[t].height=Number((e.objects[t].height*ratio).toFixed(2)),"label"==e.objects[t].type||"textbox"==e.objects[t].type?""!=e.objects[t].Font.Size?e.objects[t].Font.Size=parseInt(parseFloat(e.objects[t].Font.Size)*ratio):e.objects[t].Font.Size=parseInt(parseFloat($waiReport.const.defFontSize)/$waiReport.const.fontScale*ratio):"image"==e.objects[t].type&&null!=e.objects[t].zoomRatio&&(console.log(e.objects[t].zoomRatio,ratio),e.objects[t].zoomRatio=e.objects[t].zoomRatio*ratio));e.endUpdate()}for(var t in null!==rpt.header&&e(rpt.header),c)e(c[t]);null!==rpt.footer&&e(rpt.footer)}();for(var u=t.length>0?t[0]:{},f=null,m=null,v=0;v<c.length;v++)"pageHeader"==c[v].type?f=c[v]:"pageFooter"==c[v].type&&(m=c[v]);function y(e,t,i){if(l){var n=0,r=null;for(e.beginUpdate(),n=0;n<e.objects.length;n++)if("textbox"==(r=e.objects[n]).type)if("4"==r.summaryType&&"0"==r.summaryFunc&&"2"==r.summaryRunning)r.text=genPrevInfo.curPageIdx+1-S+"",r.dataField="";else if("4"==r.summaryType&&"0"==r.summaryFunc&&"0"==r.summaryRunning)r.text=t.pageCount-S+"",r.dataField="";else if("1"==r.summaryType){var s=i[r.name+"_"+r.dataField];void 0!==s&&(r.text=s,r.dataField="")}e.endUpdate()}}function b(e,t,i){if(!l)return!1;var n=genPrevInfo.curCanvas.getContext("2d"),r=0;switch(i){case 0:r=genPrevInfo.curTop;break;case 1:r=genHeight-t}n.drawImage(e,0,r)}var w=!1;function x(e){if(l)switch(e.type){case"pageHeader":case"pageFooter":break;case"detail":sysValues.detailIndex++,sysValues.detailIndexOfPage++,sysValues.detailIndexOfGroup++;break;case"groupHeader":case"groupFooter":sysValues.detailIndexOfGroup=0,sysValues.groupIndex[e.name]=void 0!==sysValues.groupIndex[e.name]?sysValues.groupIndex[e.name]:0,sysValues.groupIndexOfPage[e.name]=void 0!==sysValues.groupIndexOfPage[e.name]?sysValues.groupIndexOfPage[e.name]:0,sysValues.groupIndex[e.name]++,sysValues.groupIndexOfPage[e.name]++}else switch(e.type){case"detail":sysValues.detailTotal++;break;case"groupHeader":case"groupFooter":sysValues.groupTotal[e.name]=void 0!==sysValues.groupTotal[e.name]?sysValues.groupTotal[e.name]:0,sysValues.groupTotal[e.name]++}}function C(e,t,i,n,s){void 0===n&&(n=0),e.setCompValues(t),self.exeBandScript(i[e.name],"OnFormat");for(var a=0;a<e.objects.length;a++){var h=e.objects[a];"textbox"==h.type&&void 0!==h.dataField&&""!==h.dataField&&(t[h.dataField]=h.text)}if(self.exeBandScript(i[e.name],"OnBeforePrint"),e.height>0||"groupFooter"==e.type){e.canGrow&&self.canGrowResize(e);var c=void 0===e.newPage?"0":e.newPage;1==w?(w=!1,null!==m&&(m.canGrow&&self.canGrowResize(m),p=p<0?m.height:p+m.height,C(m,t,i,1)),D()):("1"==c||"3"==c||e.height>p)&&(null!==m&&(m.canGrow&&self.canGrowResize(m),p=p<0?m.height:p+m.height,C(m,t,i,1)),D()),e.height>0&&(x(e),l&&(y(e,r,t),setSysValues(e),o?e.draw(t):g(e,t)),o&&b(e.canvas,e.height,n),p-=e.height,genPrevInfo.curTop=genPrevInfo.curTop+e.height),"2"!=c&&"3"!=c||!0!==s&&(w=!0)}self.exeBandScript(i[e.name],"OnAfterPrint")}var P=!1,S=0;function D(){if(function(){if(l){if(!o){var e=JSON.parse(JSON.stringify(rpt.formData.pageSetting));e.paper.width=genWidth,e.paper.height=genHeight;var t={screenPrvInfo:{prevLoadedImages:rpt.prevLoadedImages},pageSetting:e,bands:[],resizeRatio:ratio};printPage.push(t)}0===genPrevInfo.pageTotal?(genPrevInfo.curCanvas=document.createElement("canvas"),genPrevInfo.curCanvas.width=genWidth,genPrevInfo.curCanvas.height=genHeight):(a(genPrevInfo.curPageIdx,genPrevInfo.curCanvas),genPrevInfo.curCanvas.getContext("2d").clearRect(0,0,genWidth,genHeight)),sysValues.detailIndexOfPage=0,sysValues.groupIndexOfPage={}}genPrevInfo.pageTotal++,genPrevInfo.curPageIdx=genPrevInfo.pageTotal-1,genPrevInfo.curTop=0}(),p=genHeight,null!==i&&(u=t.length>0?t[0]:{}),0==genPrevInfo.curPageIdx){try{self.exeScript(d.report.OnReportStart,"OnReportStart")}catch(e){}if(null!==rpt.header)(h=rpt.header).setCompValues(u),self.exeBandScript(d.bands[h.name],"OnFormat"),self.exeBandScript(d.bands[h.name],"OnBeforePrint"),h.height>0&&(x(h),l&&(y(h,r),setSysValues(h),o?h.draw(u):g(h,u)),o&&b(h.canvas,h.height,0)),self.exeBandScript(d.bands[h.name],"OnAfterPrint"),genPrevInfo.curTop=genPrevInfo.curTop+h.height,p-=h.height,"2"==(void 0===h.newPage?"0":h.newPage)&&(P=!0)}else P&&(P=!1,S++);P?D():(null!==f&&C(f,u,d.pages[e].bands,0),null!==m&&(p-=m.height))}var O=!1;D(),function e(t,n,r,s){function a(e,t,i,n){for(var s=0;s<t.length;s++){var a=t[s];u=a,C(e,t[s],r,0)}}var o;if(null==s&&(s=""),null==t.header)a(t.child,null!==i?i:n);else{var h=t.header.dataField,c=groupingData(h=""!==h&&void 0!==h?h:"[#NoGroup#]",n);if(c.grouped)for(o=0;o<c.grpKeys.length;o++){var d=c.groups[c.grpKeys[o]],p=execGroupSummary(t,t.header,d.recs);for(var g in p)try{d.last[g]=p[g]}catch(e){}O,C(t.header,d.first,r,0),e(t.child,d.recs,r,s+"  "),C(t.footer,d.last,r,0,o+1===c.grpKeys.length)}else{var f=c.recs.length>0?c.recs[0]:{},m=c.recs.length>0?c.recs[c.recs.length-1]:{};if(C(t.header,f,r,0),e(t.child,c.recs,r,s+"  "),l){p=execGroupGrandSum(t,t.header,c.recs);for(var g in p)m[g]=p[g]}C(t.footer,m,r,0)}}}(buildPrintProc(c),t,d.pages[e].bands),null!==m&&(p+=m.height,C(m,u,d.pages[e].bands,1)),null!==rpt.footer&&((h=rpt.footer).setCompValues(u),this.exeBandScript(d.bands[h.name],"OnFormat"),this.exeBandScript(d.bands[h.name],"OnBeforePrint"),h.height>0&&(p<=h.height&&(D(),null!==m&&(p+=m.height,C(m,u,d.pages[e].bands,1))),x(h),l&&(y(h,r),setSysValues(h),o?h.draw(u):g(h,u)),o&&b(h.canvas,h.height,0)),this.exeBandScript(d.bands[h.name],"OnAfterPrint"));try{this.exeScript(d.report.OnReportEnd,"OnReportEnd")}catch(e){}l&&(a(genPrevInfo.curPageIdx,genPrevInfo.curCanvas),this.clearPrevBuffer())},this.generateSubRepPreview=function(e,t,i,n,r,s){ratio=s;var a=rpt.formData.pageSetting;genWidth=a.paper.width*ratio;var o=$waiReport.const.paperRatios,h=(a.paper.type+"").toUpperCase(),l=1===_paperOrient?"horz":"vert",c=o[h];void 0===c&&(console.warn('[waiReport] paper type "'+h+'" undefined as "waiRepConst" setted "A4" paper'),h="A4"),c=o[h][l],genHeight=Math.floor(a.paper.width*c);var d=JSON.parse(JSON.stringify(rpt.formData));console.log('[waiReport] Generate "preview" paper info "'+self.loadedFormUrl+'"\n\nform-width  : '+a.paper.width+"px\nform-height : "+a.paper.height+"px\n\nPaper type   : "+h+"\nPaper orient : "+l+"\nPaper vertical Ratio : "+c+"\n\nPaper Width  : "+genWidth+" px\nPaper Height : "+genHeight+" px\nResize Ratio : "+ratio+"\nMax Band Height : "+Math.floor(genHeight/ratio)),this.clearPrevBuffer(),this.generateScript(),this.generateSummary();for(var p=0;p<rpt.pages.length;p++){rpt.loadFormData(JSON.parse(JSON.stringify(d))),this.generatePreviewPage(p,e,t,!1,void 0,i,n,r);var g={pageCount:genPrevInfo.pageTotal};null!==i&&i(genPrevInfo),this.clearPrevBuffer(),rpt.loadFormData(JSON.parse(JSON.stringify(d))),this.generatePreviewPage(p,e,t,!0,g,i,n,r)}return!0},Object.defineProperty(this,"pageIndex",{get:function(){return _pageIndex},set:function(e){_pageIndex=e}}),Object.defineProperty(this,"report",{get:function(){return rpt}}),Object.defineProperty(this,"buffer",{get:function(){return bufCanvas}}),Object.defineProperty(this,"pages",{get:function(){return prevPages}}),Object.defineProperty(this,"horzPages",{get:function(){return prevPagesHorz}}),Object.defineProperty(this,"printPages",{get:function(){return printPage}}),this.init()};$waiReport.classes.reportViewer=_yrReportViewer;var _core=function(){var compDefault=null,compBases=[];this.loadComponentScript=function(e,t,i){$waiReport.log.add("Y[wai] Report Components Loaded"),$waiReport.loader.loadLibrary(e,t,i)},this.addComponentBase=function(e){"default"==e.declare.type?compDefault=e:compBases.push(e),$waiReport.log.add("["+e.declare.type+"] component base loaded")},this.getComponentBase=function(e){for(var t=null,i=(e+"").trim().toUpperCase(),n=0;n<compBases.length;n++){if(i===(compBases[n].declare.type+"").trim().toUpperCase()){t=compBases[n];break}}return t},this.getComponentList=function(){for(var e=[],t=0;t<compBases.length;t++){var i={type:compBases[t].declare.type};e.push(i)}return e},this.createComponent=function(parentCls,attrInfo,compType){var rt=null,cb=this.getComponentBase(compType);if(null===cb){var E=new Error;return debug&&console.error($waiReport.message.get("compNotFound",[compType]),E),null}var _fontProps=$waiReport.const.compStyleFontProp,_StyleProps=$waiReport.const.compStyleProp,compStyleInst=function(parCls,cssText,propInst){{function defStyleProp(e){return'Object.defineProperty(this,"'+e+'",{\nget : function(){return props["'+e+'"].value;},set : function(v){\n    props["'+e+'"].value = ((props["'+e+'"].gen!==undefined)?props["'+e+'"].gen(v):v);\n    this.propChanged("'+e+'",v);\n}});'}function StylePropToCSSText(e){var t="";for(var i in e){var n=void 0!==e[i].ret?e[i].ret(e[i].value):e[i].value;""!=(n+"").trim()&&(t+=e[i].css+":"+n+"; ")}return t.trim()}function cloneObject(e){if(null===e||"object"!=typeof e)return e;var t=e.constructor();for(var i in e)t[i]=cloneObject(e[i]);return t}}var props=cloneObject(propInst);this.init=function(e){var t=[];for(var i in props)props[i].value="";if(""!=(e+"").trim()){var n,r=(e+"").trim().split(";");for(n=0;n<r.length;n++)if(""!=(r[n]+"").trim()){var s=(r[n]+"").trim().split(":");if(2==s.length){var a={name:(s[0]+"").trim().toLowerCase(),value:(s[1]+"").trim()};a.value="inherit"===a.value?"":a.value,t.push(a)}}for(n=0;n<t.length;n++)for(var i in props)if(props[i].css===t[n].name){props[i].value=t[n].value;break}}for(var o in childs)childs[o].init(e);this.genCssText()},this.genCssText=function(e){var t=StylePropToCSSText(props);for(var i in childs)childs[i].genCssText(),t+=" "+childs[i].cssText;if(strValue=t,!0===e&&null!==parCls)if(parCls.classType==this.classType)parCls.genCssText(e);else try{parCls._styleChanged.apply(parCls)}catch(e){console.warn("_styleChanged not found",e,parCls)}},this.propChanged=function(e,t){this.genCssText(!0)},this.addChild=function(cName,cObj){childs[cName+""]=cObj,eval('Object.defineProperty(this,"'+cName+'",{ get : function(){ return childs["'+cName+'"]; }});')};var childs={},strValue="";for(var x in Object.defineProperty(this,"classType",{get:function(){return"yrStyleClass"}}),Object.defineProperty(this,"parent",{get:function(){return parCls}}),Object.defineProperty(this,"children",{get:function(){return childs}}),Object.defineProperty(this,"cssText",{get:function(){return strValue},set:function(e){this.init(e)}}),props){var evTxt=defStyleProp(x);eval(evTxt)}""!=(cssText+"").trim()&&this.init(cssText)},compInst=function(parCls,attrs,cBase){var _type=cBase.declare.type,self=this,beforeInit=!0;this.band=parCls;var styles=this.band.report.formData.styles;this.init=function(){try{this.initialize(),beforeInit=!1}catch(e){console.error("init Error : ",this,e)}},this.ctrlOpt={borderOff:{top:!1,left:!1,bottom:!1,right:!1}},this.doDraw=function(e,t){try{if("0"==this.visible)return;this.execDraw(e,t),this.defExecDraw(e,t)}catch(e){console.error("doDraw Error : ",this,e)}},this.updateCanvas=function(e){null!==parCls&&parCls.updateCanvas(e)},this.propChanged=function(pName,newValue){try{var link=this.propertyNames[pName].info.link;if(void 0!==link&&""!==link){var linkVal="string"==typeof newValue?'"'+newValue+'"':newValue+"",evStr="this."+link+"="+linkVal+";";eval(evStr)}else parCls.reDraw(!0)}catch(e){console.error("propChanged Error : ["+pName+'] = "'+newValue+'"',this,e)}},this._styleChanged=function(){beforeInit||(attrs.style=this.style.cssText,parCls.reDraw())};var compStyle=new compStyleInst(this,"",_StyleProps);compStyle.addChild("Font",new compStyleInst(compStyle,"",_fontProps));var styText=attrs.style,x,cp;if(null==styText&&void 0!==styles){var stName=styles[attrs.className];void 0!==stName&&(styText+=";"+stName)}compStyle.init(styText),Object.defineProperty(this,"classType",{get:function(){return"yrComponentClass"}}),Object.defineProperty(this,"type",{get:function(){return _type}}),Object.defineProperty(this,"style",{get:function(){return compStyle}}),Object.defineProperty(this,"Font",{get:function(){return compStyle.children.Font}}),Object.defineProperty(this,"parent",{get:function(){return parCls}}),Object.defineProperty(this,"info",{get:function(){return attrs}}),this.propertyNames={},this.__defCompProp=function(pNm,cp){var pDefS='Object.defineProperty(this,"'+pNm+'",{\n',pDefE="\n});",pGet='get : function() { return attrs["'+pNm+'"]; }',pSet='set : function(v){ attrs["'+pNm+'"] = v; this.propChanged("'+pNm+'",v); }',pNotProp='set : function(v){ attrs["'+pNm+'"] = v;}',evalStr="";evalStr=cp.readonly?pDefS+pGet+pDefE:0==cp.propChange?pDefS+pGet+",\n"+pNotProp+pDefE:pDefS+pGet+",\n"+pSet+pDefE,eval(evalStr)};var excProp=void 0!==cBase.exceptProps?cBase.exceptProps:{};for(x in compDefault.properties)void 0===excProp[x]&&(cp=compDefault.properties[x],this.propertyNames[x]={cate:"def",info:JSON.parse(JSON.stringify(cp))},this.__defCompProp(x,cp));for(x in cBase.properties)cp=cBase.properties[x],this.propertyNames[x]={cate:"comp",info:JSON.parse(JSON.stringify(cp))},this.__defCompProp(x,cp)};compInst.prototype.defExecDraw=compDefault.execDraw;for(var mergeList=["declare","initialize","execDraw"],i=0;i<mergeList.length;i++)compInst.prototype[mergeList[i]]=cb[mergeList[i]];return rt=new compInst(parentCls,attrInfo,cb),rt.init(),rt}};$waiReport.classes.reportCore=_core})(),$waiReport.core=new $waiReport.classes.reportCore,$waiReport.core.loadComponentScript.apply($waiReport.core,[$waiReport.components.path,$waiReport.components.loadSequence,$waiReport.components.loadInfo]),$(document).ready((function(){$waiReport.debug>0?$waiReport.log.printGroup(!0,1):$waiReport.log.clear()}));